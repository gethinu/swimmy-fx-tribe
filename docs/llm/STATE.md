# Swimmy System State

## 現在の状態
- **稼働フェーズ**: V50.6 (Structured Telemetry) - 2026-02-03
- **Rust (Guardian)**: `V15.x` Full Duplex, Risk Gate実装済み。Daily Loss Limit: -¥5000。
- **MQL5 (Bridge)**: `V15.2` Multi-TF対応。
- **Lisp (Brain/School)**: `V50.6` Pure Lisp Daemon。SQLite移行完了。
- **Multi-Symbol Evolution**: `swimmy.core::*supported-symbols*`（既定 `USDJPY/EURUSD/GBPUSD`）を「進化・候補生成の対象」として扱う。起動時の Founder 注入（`recruit-special-forces`）は supported symbols ごとに Founder を展開し、`strategy.symbol` を正しく付与して backtest を回す（EURUSD/GBPUSD が `A Candidate Funnel` に出ない問題の正本修正）。
  - **Symbol Name Contract (P12.5)**: symbol override で生成する Founder 変種は、名前にも symbol を含める（例: `...-EURUSD`）。これにより `check-symbol-mismatch` が「名前とsymbolの取り違え」を実際にブロックできる。
  - **Duplicate/Correlation Scope**: `add-to-kb` / Founder preflight の correlation screening（Jaccard/Highlander）は **(timeframe × direction × symbol) の同一カテゴリ内のみ**で適用し、**同一ロジックの multi-symbol 展開**（例: USDJPY と EURUSD）をブロックしない。
- **MCP Gateway**: read-only/backtest-execのみ有効。trade-capableは封印（403固定）。
- **Backtest Service**: Python ZMQサービス（`SWIMMY_BACKTEST_SERVICE=1` 時に有効）。BrainからのBACKTESTを 5580 で受信し、結果を 5581 で返却。
- **Lifecycle**: Rank（Incubator/B/A/S/Legend/Graveyard/Retired）が正義。Tierロジックは廃止（保存はRankディレクトリ）。
- **Timeframe Canonical Contract**: 戦略の内部時間足は **分（minutes, int）** を正本とする。既定スコープは 8TF バケット（`5/15/30/60/240/1440/10080/43200`）だが、進化/バックテスト探索では任意TF（例: `36/120/300/3600` 分）を許容する。カテゴリ分割・相関判定・Pattern Gate 判定は有限バケットへ正規化して扱い、探索候補集合は budget 制御で上限化する。
- **Aux Services**: Data Keeper / Notifier / Risk Gateway / Pattern Similarity Service / Inference Worker は **S式 + schema_version=1** のみ受理（ZMQでJSONは受理しない）。
- **Dispatcher S式 bool互換契約**: `safe-read-sexp` / `internal-process-msg` は Rust `serde_lexpr` 由来の `#t/#f` を `t/nil` と同義で受理し、sharp-boolean を含む受信S式を `Unsafe/invalid SEXP` として誤棄却しない。
- **Dispatcher invalid S式可観測性契約**: `Unsafe/invalid SEXP` ログには payload 先頭プレビュー（`head`）を含め、破損入力の発生源をログだけで特定できる状態を正本とする。
- **Polymarket OpenClaw（任意）**: Polymarket（予測市場）向けの自動エントリーサブシステム。cycle/signal-sync は user systemd、status/notifier は systemd(system) を使用し、成果物は `data/reports/polymarket_openclaw_live/` に保存する（FX コアとは独立）。
- **XAU AutoBot（任意・別系統）**: FXコア（Rust/Lisp）とは独立した MT5 補助運用。`Swimmy-XAU-Cycle` は最適化/プローブ/active config 更新のみを担当し、**実注文の正本は `Swimmy-XAU-Exec`（ONLOGON）または Startup launcher (`Swimmy-XAU-Exec.vbs`) で `tools/windows/xau_autobot_live_loop.ps1 -Live` を常駐起動すること**。`-Live` 未指定は `dry_run` となり注文は送信されない。
- **Structured Telemetry**: `/home/swimmy/swimmy/logs/swimmy.json.log` にJSONL統合（`log_type="telemetry"`、10MBローテ）。
- **Telemetry Write Fallback**: 主要ログ `/home/swimmy/swimmy/logs/swimmy.json.log` へ書けない場合は `data/memory/swimmy.telemetry.fallback.jsonl` へフォールバックし、イベントロストを抑止する。
- **Execution Spread/Slippage Telemetry**: 注文時の `entry_bid/entry_ask/spread_pips` をログ化し、`TRADE_CLOSED` に `entry_price` が含まれる場合はスリッページ(pips)も算出・記録する。スプレッドが上限超過の場合は `execution.spread_reject` として拒否理由を記録する。
- **ORDER_OPEN コメント契約**: `comment` はトップシグナル戦略の実行文脈（`strategy_name|tf_key`）を送る。`NIL` 名や「文脈欠落による `M1` フォールバック」をコメントへ出さない。`M1` は戦略TFが実際に1分足のときのみ許容する。
- **Execution Fail-Closed 契約**: 実行文脈（`strategy_name` / `timeframe`）が欠落・不正な場合は、`NIL` や既定TFへ丸めずに**発注を中止**する。`NIL` で先に進むフォールバックを禁止する。`timeframe="NIL"` / 空文字 / 不正ラベル（例: `"UNKNOWN"`）は「不正な時間足」として fail-closed 対象にする。
- **ORDER_OPEN Sink Guard 契約**: `safe-order` / `make-order-message`（Sender）と `SwimmyBridge ORDER_OPEN`（Receiver）は `comment` を厳格検証し、`strategy|tf` 形式不正（区切り欠落、strategy/timeframe 欠落、`NIL` 含有）を検知した場合は `SW-<magic>` 等へフォールバックせず fail-closed で中止する。
- **Fail-Closed 可観測性契約**: fail-closed で発注を中止した場合は、`notify-discord-alert` による運用アラートと `execution.context_missing` telemetry を同時出力し、運用者が即時検知できる状態を正本とする。
- **Local Storage**: `data/backtest_cache.sexp` / `data/system_metrics.sexp` / `.opus/live_status.sexp` をS式で原子保存（tmp→rename）。`backtest_cache/system_metrics` は `schema_version=1`、`live_status` は `schema_version=2`。
- **Daily PnL Aggregation**: `strategy_daily_pnl` を日次集計（00:10 JST）、非相関スコア計算に使用。
- **Graveyard/Retired 指標**: Evolution Report は DB（`get-db-rank-counts`）を正本、Libraryファイル数はドリフト検知に使用。
  - **Report表示**: Graveyard/Retired は DB値を表示しつつ、Libraryとの差分（ドリフト）も併記する（「数がリセット」誤解を防ぐ）。
  - **Drift内訳表示**: `Source Drift` は **canonical（GRAVEYARD+RETIRED の unique-name）を主指標**とし、`delta(DB-LibraryCanonical)` を正本の差分として表示する。Libraryは同名ファイルが `GRAVEYARD/` と `RETIRED/` の両方に残ることがあり、その場合 **raw dir count は overlap 分だけ二重計上**されるため、per-dir の `delta(DB-Library)` は誤読（「数がリセット」等）を誘発しやすい。従って drift 判定は canonical を優先し、raw は `overlap` とセットで説明目的に限定する。
  - **ドリフト修復**: `tools/ops/reconcile_archive_db.py` で `data/library/GRAVEYARD/`・`data/library/RETIRED/` をスキャンし、DBへ backfill / rank補正できる（非破壊、ただし大量更新のため運用タイミングに注意）。
  - **ドリフト修復の実行安定化**: 稼働中に archive ファイルが増減する環境では、`reconcile_archive_db.py` の `--grace-sec` で直近更新ファイルを保留してから補正する。`--grace-sec` の既定は `0`（無効）で、指定時は `mtime > (scan_start - grace_sec)` の archive を今回スキャン対象から除外する。これにより実行中レースで `wrong_rank` が再発し続ける現象を抑制する。
  - **ドリフト修復（自動）**: `swimmy-archive-reconcile.timer`（systemd, system scope）を `enabled` にして定期実行し、`reconcile_archive_db.py` による DB rank補正 / backfill / DB-only archive prune を自動化する。運用の既定は `--no-data-sexp`（DB肥大抑制）+ `--grace-sec`（レース緩和）+ `--prune-db-only`（backup table 退避後に prune）で、ログは `logs/archive_reconcile.log` に追記する。
  - **Archive Migration 読み込み耐性**: `migrate-existing-data` の graveyard 読み込みは行単位 `safe-read-sexp` で実行し、壊れた行をスキップして継続する。先頭5件まで `Skip malformed graveyard line` を記録し、1行の破損で全体 migration が停止しないことを正本とする。
  - **B再シード運用**: Active母集団が archive 偏重で枯渇した場合、`tools/ops/reseed_active_b.py` で `:GRAVEYARD/:RETIRED` から Stage1 B 基準通過戦略をカテゴリ（TF×Direction×Symbol）ごとに上位N抽出し、`:B` へ復元する。復元時は DB ランク更新と Library ファイル移動（`GRAVEYARD/RETIRED -> B`）を同時適用する。
    - **権限差分耐性**: strategyファイルの `:RANK/:STATUS` 書換は in-place ではなく `tmp書込 -> os.replace` の原子置換で行い、root所有ファイル混在時でもディレクトリ書込権限があれば再シードを継続できる。
    - **重複名競合の解決規約**: 同名ファイルが `B/` と archive (`GRAVEYARD/RETIRED`) の両方に存在する場合は `B/` 側を正とし、reseed 時に `:B` への DB昇格を継続する（conflictで丸ごとスキップしない）。
  - **Archive Rank 保護**: DB既存ランクが `:GRAVEYARD/:RETIRED` の場合、通常の `upsert-strategy` で `NIL/Active` に戻さない（明示的なランク遷移のみ許可）。
- **Graveyard Avoidance (P3)**: `analyze-graveyard-for-avoidance` は巨大な `data/memory/graveyard.sexp` をストリーム処理し、途中の破損フォーム（例: `unmatched close parenthesis`）で全体を中断せずにスキップして継続する。結果は `SWIMMY_GRAVEYARD_AVOID_CACHE_SEC`（既定300秒）でキャッシュし、Breeder が child 生成ごとにファイル全走査しないことを正本とする。**Read error のログは条件オブジェクトを丸ごと print せず**、`File-Position/Stream` 等の詳細を出さない（巨大ファイルの破損位置でログ出力自体が大規模割り当てになり OOM するのを防ぐ）。
- **Top Candidates 表示**: Evolution Report の Top Candidates は **Active候補のみ**（Graveyard/Retired除外）。DBの `rank=NIL` は表示上 `INCUBATOR` として扱う（NILをそのまま出さない）。
  - 並び順は `evidence-adjusted-sharpe(sharpe, trades)` を正本とし、表示は `S=<adjusted> (raw <raw>)` とする（`trades` 欠損は 0 扱い）。
- **CPCV Status 表示**: 複数Lispデーモン間で「送信」と「受信」が分離するため、CPCVステータスは `data/reports/cpcv_status.txt` を正本として表示する（`last_start_unix` を保持して N/A を避ける）。
  - **reason伝播**: `cpcv_status.txt` の `updated: ... reason: <reason>` が存在する場合、Evolution Report の `CPCV Status` 行にも reason を表示する（`no-candidates` と runtime/criteria 失敗を誤読しないため）。
  - **failed内訳**: `failed` は `send_failed + result_failed` の合算で、`result_failed` は `runtime` と `criteria` の内訳を表示する。
  - **結果分類**: `CPCV_RESULT` は `error` がある場合に `runtime` 失敗として扱う。加えて `path_count/passed_count/failed_count` がすべて 0 の結果は `error` 未付与でも **無効結果** とみなし、`criteria` ではなく `runtime` 失敗として扱う。
  - **通知対象**: CPCV個別通知は既知戦略（KBまたはDBに存在する `strategy_name`）のみ送信し、未知戦略名の結果はメトリクス/履歴には残しても Discord alert は送信しない。
  - **履歴CSV耐性**: CPCV個別通知は `data/logs/cpcv_history.csv` にも記録するが、`median_sharpe/pass_rate` などの数値が欠落・`NIL` の場合でも 0.0 として記録し、通知/受信ループを `Msg Error` で落とさない。
- **CPCV Validate (評価条件)**: Guardian の `CPCV_VALIDATE` は `strategy_params` の `indicator_type/timeframe/filter_*` を解釈して（可能なら）Backtestと同等の条件でCPCVを評価する（timeframe>1はResample、filter有効時は同一データからauxを生成してMTF filter適用）。
- **CPCV Validate メモリ契約**: Guardian の `CPCV_VALIDATE` は 1リクエスト内で `candles_file` を1回だけロードし、各 path/range 評価は同一 candle バッファのスライスを再利用する。pathごとのCSV全件再読込を禁止する。
- **CPCV Validate (S式キー解釈)**: Guardian は `CPCV_VALIDATE` のトップレベルキーを正規化して解釈する（`action` だけでなく `swimmy.school::action` / `swimmy.school:action` など package 修飾キーも受理）。
- **OOS Queue 計上**: `sent/retry` は「Backtest dispatch を受理した要求」のみ計上する。送信拒否/スロットル時は `sent` に残さず `error` として再試行対象に戻す。
- **OOS Status 表示**: `oos_status.txt`/Evolution Report の OOS 行は、`report-oos-db-metrics`（DB集計）に加えて `report-oos-failure-stats`（`data/send/db`）と `report-oos-metrics`（latency avg/min/max）を表示し、固定ゼロ値を出さない。
- **Notifications**: Max Age Retirement と Stagnant C-Rank の `Strategy Soft-Killed (Cooldown)` は個別通知を抑制し、**1時間ごと**に「合計件数＋上位5件名」でサマリ送信。
- **School Heartbeat Tick**: `data/heartbeat/school.tick` は School の独立tick（既定60秒）で更新する。長時間サイクル中でも heartbeat を更新し、Evolution report staleness alert の `heartbeat_age` がサイクル完了待ちで誤検知しないようにする。
- **School Wisdom Cadence**: `phase-7-wisdom-update` は毎サイクル実行しない。`SWIMMY_WISDOM_UPDATE_INTERVAL_SEC`（既定1800秒）で間隔制御し、重い `analyze-veterans` を常時経路から外す。
- **School Wisdom メモリ契約**: `analyze-veterans` は `unique-strats/candidates/copy-list+sort` の大規模中間リストを作らず、単一パス（de-dup + filter）で `Top-N`（既定50）だけを保持する。大量KB時の一時メモリ膨張を抑える。
- **KB統合収集の計算量契約**: `collect-all-strategies-unpruned` は DB + Library の重複統合を `strategy_name` ハッシュ集合で処理し、重複除外を O(n) で維持する。重複名がある場合は DB 側を正として保持する。
- **Strategy Lookup Index 契約**: `init-db` は `strategies` に `idx_strategies_rank_sharpe (rank, sharpe)` と `idx_strategies_category_rank (timeframe, direction, symbol, rank)` を必須作成し、ランク検索とカテゴリ別選抜の全表走査を回避する。
- **Evolution Daemon 表示**: Evolution Report の `System Status` 行は固定文言ではなく、`systemctl is-active swimmy-evolution.service` を正本に表示する。`systemctl` 取得不能時のみ heartbeat 更新時刻で補助判定し、停止中に `Active` と誤表示しない。
- **Evolution Report 保存先**: レポート保存は `*evolution-report-path*` を正本とし、`write-evolution-report-files` は固定パスを直接書かない。テスト/運用で保存先をバインド可能にして本番 `data/reports/evolution_factory_report.txt` の意図しない上書きを防ぐ。
  - **テスト隔離**: `run-all-tests` は `*evolution-report-path*` を `data/memory/swimmy-tests-evolution-report.txt` へバインドし、本番レポートを汚染しない。
- **Test Telemetry 隔離契約**: `deftest` 実行は単体呼び出し（`(swimmy.tests::test-...)`）でも telemetry 出力先を `data/memory/swimmy-tests-telemetry*.jsonl` にバインドし、本番 `logs/swimmy.json.log` へテスト由来 WARN/telemetry を混入させない。
- **Backtest Status 保存先**: `maybe-log-backtest-recv` の backtest status 書き込み先は `swimmy.main::*backtest-status-path*` を正本とし、固定パス `data/reports/backtest_status.txt` を直接書かない（テスト/監査で保存先をバインド可能にして本番 status を汚染しない）。

## 決定事項
- **アーキテクチャ**: Rust Guardianを中心としたハブ＆スポーク。
- **永続化**: SQLite (`swimmy.db`) と Sharded Files (`data/library/`) のハイブリッド。
- **サービス管理**: Systemdによるコア4サービス＋補助サービス体制。
- **System Audit**: `tools/system_audit.sh` を正本とし、systemd(system) を監査・自動修復（daemon-reload + enable + restart）。`DRY_RUN=1` で修復をスキップ。`SUDO_CMD` で sudo 実行方法を上書き可能（例: `SUDO_CMD="sudo"` で対話式許可）。`sudo -n` が使えない環境でも `systemctl` 直実行で監査を継続し、監査自体をスキップしない。**このフォールバック自体は運用上正常であり WARN にしない**（健康状態のWARNはサービス/監査項目の実体に限定）。`.env` を自動読み込みして Discord 設定を拾う。
  - **Polymarket OpenClaw（任意）**: `swimmy-polymarket-openclaw.timer` が `enabled` のときのみ `tools/polymarket_openclaw_status.py --fail-on-problem` を監査に含める。timer が無効（`disabled/static/not-found` 等）なら OpenClaw は「意図的に無効化」とみなし、監査は `SKIP (disabled)` 表示で WARN にしない（stale 誤検知を防ぐ）。
    - **Statusのdisabled扱い**: `tools/polymarket_openclaw_status.py` は cycle timer が `enabled` でない場合 `Health: disabled` として扱い、`--fail-on-problem` 指定でも exit 0 とする（OpenClaw停止中に status ファイルが更新されず stale になるのは仕様のため）。
  - **sudo -n 不可フォールバック**: `sudo -n` が使えない場合でも監査は `systemctl` 直実行（status-only）で継続し、**フォールバック自体は WARN にしない**。修復（enable/restart）が必要な運用では `SUDO_CMD="sudo"`（対話式）または passwordless sudo を前提とする。
  - **sudo 可用性の判定（systemctl限定NOPASSWD対応）**: `sudo -n true` の可否ではなく、`SUDO_CMD systemctl is-active swimmy-brain.service` の実行可否で「非対話 sudo が systemctl に使えるか」を判定する。これにより「systemctl だけ NOPASSWD（allowlist sudoers）」の環境でも restart 修復が動作する。
  - **権限不足時の修復スキップ**: `Interactive authentication required`（polkit）および `sudo: a password is required`（sudoers非許可）は **FAIL 扱いにせず WARN で skip** し、監査を継続する。
  - **Pattern Similarity fallback 健全判定**: `swimmy-pattern-similarity.service` が未登録/停止でも、`tools/pattern_similarity_service.py` 実プロセスが稼働し `:5564` が LISTEN なら監査上は稼働扱いとする（systemd未管理である旨は WARN で残す）。
  - **Pattern Similarity のsystemd復帰**: systemd修復（`SUDO_CMD` で sudo 実行可能）が行える場合、unit が inactive なのに fallback プロセスが稼働している状態は運用ドリフトとして扱い、fallback を停止して `enable/restart` により systemd 正本へ復帰させる。
    - **安全規約**: unit の `LoadState=not-found`（未インストール）の場合は fallback を停止しない（停止すると 5564 が無に落ちるため）。この場合は WARN で継続し、先に `sudo bash tools/install_services.sh`（または同等の unit 配置）を促す。
  - **Dashboard表示整合**: `tools/dashboard.py` の `PatternSim` 表示は systemd unit 状態だけでなく fallback 健全判定（`pattern_similarity_service.py` + `:5564` LISTEN）を参照し、unit未登録でも誤って常時 `inactive` と表示しない。
  - **権限不足時の修復挙動**: `enable/restart` が `Interactive authentication required` で失敗する環境では修復を FAIL 扱いにせず WARN でスキップし、監査の観測結果（status/dashboard/log/DB）を継続する。
  - **Deep Audit スケーリング**: `tools/deep_audit.lisp` は archive-heavy DB（`strategies` が数十万行）でも完走することを正本とし、全件 `SELECT data_sexp` → S式復元のような巨大 materialize を監査で行わない。監査は `get-db-rank-counts` / `get-library-rank-counts` / `get-library-archive-canonical-count` / `map-strategies-from-db`（limit付き）などのストリーミング観測で実施する（Archive drift は per-dir mismatch に加えて Library canonical/overlap も併記して誤読を防ぐ）。
- **運用**: ログはDiscordに集約。`./tools/monitor_evolution.sh` で状況確認。
- **運用（Brain起動）**: `swimmy-brain` は systemd 経由のみで起動する。cron watchdog `tools/check_guardian_health.sh` が **systemd MainPID 以外**の `/home/swimmy/swimmy/run.sh` を自動停止する（MainPID が取得できない場合は `run.sh` を全停止）。
- **運用（systemd正本）**: Swimmy FX コアは systemd(system) を正本とし、systemctl --user は診断用途のみ。Polymarket OpenClaw は user systemd（`systemctl --user`）を正本（cycle/signal-sync）とし、status/notifier は systemd(system) で監査する。
- **Evolution Loop 排他契約**: `tools/evolution_daemon.py` は `school-daemon.lisp` の稼働を監視し、後発で school が起動した場合は自身の SBCL 子プロセス（`run_lisp_evolution.lisp`）を停止して待機へ戻る。`SWIMMY_ALLOW_PARALLEL_EVOLUTION=1` 指定時のみ並列実行を許可する。
- **Rank一本化**: ライフサイクル判断は Rank のみ。Tierは判断ロジックから除外（ディレクトリもRankへ移行）。
- **Rank閾値（vNext / Balanced）**: Stage 1 固定閾値を `B: Sharpe>=0.15 PF>=1.05 WR>=35% MaxDD<25%`、`A: Sharpe>=0.45 PF>=1.30 WR>=43% MaxDD<16%`、`S: Sharpe>=0.75 PF>=1.70 WR>=50% MaxDD<10%` に更新する。
- **Rank TradeEvidence Floor**: Aは `trade evidence >= 50`、Sは `trade evidence >= 100` を必須とする。`run-rank-evaluation` で既存A/Sにも floor sweep を適用し、`evaluate-a-rank-strategy` は floor 未達を即時 `:B` へ降格して先へ進めない。
- **S Rank Conformance Sweep**: `run-rank-evaluation` は既存 `:S` 戦略に対しても `check-rank-criteria :S` を再評価し、基準逸脱した戦略を `:A`（A基準通過時）または `:B` へ降格する。trade floor のみ満たす S を残留させない。
- **Aランク WR下限の扱い**: 高RR例外を設けず、Aの `WR>=43%` を一律適用する（実装/レポート/テストを同一基準で運用）。
- **A基準不合格内訳の可視化**: Evolution/Backtest系レポートには A Stage1 基準の不合格内訳（Sharpe/PF/WR/MaxDD）を常時表示し、昇格停滞の要因を定点観測できるようにする。
- **A Near-Miss 可視化**: Evolution Report は Bランク候補のうち `a-base-deficit-score` が小さい戦略（A Stage1 に近い候補）を表示し、各候補の不足ゲート（Sharpe/PF/WR/MaxDD）を明示する。ランク閾値や昇格ゲートは変更しない。
- **レポート表示整形**: Evolution Report の `%` 表記は単一 `%` を正本とする（`%%` 表示を出さない）。A Near-Miss 候補は `strategy_name` 単位で重複を除外して表示する。
- **候補名短縮表示**: Evolution Report の候補名は先頭のみの切り詰めを禁止し、必要時は「先頭 + 末尾」を保持した短縮表示にする（同一prefixで別戦略が同名に見える衝突を防止）。
- **Validation Coverage 表示**: Evolution Report に OOS/CPCV の DB累計カバレッジ（全体/Active）を表示し、`CPCV Status` の瞬間値が 0 のときでも「未実行」か「過去実行済みで現行バッチ対象なし」かを判別できるようにする。
- **A Gate Pressure 表示**: Evolution Report に `Active B` 母集団の A Stage1 圧力（`pass_all` と Sharpe/PF/WR/MaxDD 各ゲート通過件数、および PF 近傍帯）を表示し、Sharpe上位でも A/S が 0 の主因が OOS/CPCV 以前の Stage1 かどうかを即時判別できるようにする。
- **昇格ゲート（vNext）**: Stage 2 を `A: OOS Sharpe>=0.35 かつ コスト控除後Expectancy>0`、`S: CPCV pass_rate>=70% かつ median MaxDD<12%` とし、A/S共通で `MC prob_ruin<=2%` と `DryRun実測スリッページ上限` を満たすことを必須にする。
- **昇格ゲート実装値（2026-02-11）**:
  - `A Expectancy`: `net_expectancy_pips = calculate-avg-pips(strategy) - *max-spread-pips*` を使用し、`net_expectancy_pips > 0` を必須とする（暫定的に既存スプレッド上限をコスト近似として採用）。
  - `MC gate`: `school-monte-carlo` の `prob_ruin`（`MaxDD > 20%` の発生確率）を使い、`prob_ruin <= 0.02` を必須とする。
    - 実装既定: `strategy-pnl-history` が **30トレード以上**ある場合のみ判定し、`iterations=250` で評価する（不足時は不合格）。
    - **証拠不足の自己修復（Backfill）**: trade evidence（`strategy-trades` 等）が十分（>=30）なのに `strategy-pnl-history` が欠落している場合、`include_trades` 付き BACKTEST を自動 dispatch して trade_list を回収する（戦略ごとにスロットル）。
  - `DryRun gate`: `execution.slippage` 由来の `slippage_pips` 実測値の `p95(abs(slippage_pips))` を使い、`p95 <= *max-spread-pips*` を必須とする（サンプル不足時は不合格）。
    - 実装既定: 戦略ごとに `execution.slippage` を蓄積し、**20サンプル以上**で `p95` を算出する（不足時は不合格）。
    - **証拠収集（約定確認時）**: MT5 が `POSITIONS` に `entry_price` を含める環境では、Pending→Warrior 昇格（約定確認）時に `entry_price` を使って slippage を算出し、DryRun slippage サンプルへ追加できる（trade close を待たずに証拠を蓄積）。
    - 永続化方針: `dryrun_slippage_samples` テーブルへ保存し、戦略ごとに最新 `*dryrun-slippage-sample-cap*` 件（既定200件）を保持する。再起動後もゲート判定を継続できるようにする。
    - 削除ポリシー: `*dryrun-slippage-max-age-seconds*` が正の値のとき、`dryrun_slippage_samples` の古い行（`observed_at` が保持期間外）を戦略単位で削除する。`NIL` は期間削除を無効化。
- **選抜/投票スコア**: Selection Score は Sharpe + PF + WR + (1-MaxDD) を合成（重み: 0.4 / 0.25 / 0.2 / 0.15）。投票ウェイトは `1.0 + 0.6*score` を `0.3–2.0` にクランプ。
- **Graveyard/Retiredの正**: Evolution ReportはDB、Libraryはドリフト検知の正本（`data/library/GRAVEYARD/*.lisp` / `RETIRED/*.lisp`）。
- **Archive Drift Reconcile 契約**: `tools/ops/reconcile_archive_db.py` は Library→DB 補完だけでなく、DB側余剰アーカイブ名（DB-only）件数を可視化する。必要時はオプションで DB-only 行をバックアップテーブルへ退避してから prune できる（既定は非破壊）。
- **B案方針**: 内部ZMQ＋補助サービス境界をS式へ統一。**ZMQはS式のみでJSONは受理しない**。外部API境界はJSON維持。**ローカル保存はS式即時単独（backtest_cache/system_metrics/live_statusを .sexp に統一）**。Structured TelemetryはJSONLログに集約。
- **MT5プロトコル**: Brain→MT5 は S式を正本（ORDER_OPEN は `instrument` + `side`）。
- **Executor Pending契約**: `swimmy.globals:*pending-orders*`（UUID→(timestamp,retry,msg)）の `msg` は `ORDER_OPEN` V2 の `instrument/side/lot` を正本キーとして扱う。`ORDER_ACK` / `ORDER_REJECT` 受信時は同一UUIDの pending を即時除去し、retry/timeout へ残存させない。
- **Execution Link Freshness Gate契約**: `safe-order` は `ORDER_OPEN` 送信前に MT5 実行リンクの鮮度を検証し、`guardian heartbeat` または `ACCOUNT_INFO` が stale の場合は fail-closed で注文を中止する。中止時は `swimmy.globals:*pending-orders*` に enqueue せず、`execution.link_stale` telemetry と（スロットル付き）運用アラートで可観測化する。
- **Executor Pending Pause契約**: `check-pending-orders` は MT5 実行リンク（guardian heartbeat / ACCOUNT_INFO）が stale の間、pending retry/timeout を停止する。stale 中は pending を保持し、再送・timeout通知を行わない（復旧後に通常 retry 判定へ戻る）。
- **MT5 Bridge Command Drain契約**: `SwimmyBridge` は `OnTimer` ごとに Execution SUB (`:5560`) の受信キューを複数件 drain する。1tick1件処理で queue を滞留させない。`HEARTBEAT` は symbol ルーティング前に処理し、`_Symbol` 不一致で無視しない。
- **MT5 Bridge DeadMan 受信優先契約**: `SwimmyBridge` の `OnTimer` は Dead Man's Switch 判定より先に `:5560` 受信キューを drain し、キュー済み `HEARTBEAT` が未処理のまま誤クローズしない。
- **MT5 Bridge ACK/REJECT 到達性契約**: `SwimmyBridge` は `ORDER_ACK` / `ORDER_REJECT` 送信で短時間再送を行い、送達を at-least-once とする。受信側（Dispatcher）は同一 `id` の重複受信を idempotent に処理する。
- **MT5 Bridge ORDER_OPEN Sink Guard契約**: `SwimmyBridge` は受信 `ORDER_OPEN` の `comment` を `strategy|tf` 形式で検証し、欠落/形式不正/`NIL`/不正TFは `ORDER_REJECT` で fail-closed する。`SW-<magic>` などへのフォールバックを禁止する。
- **MT5 Bridge ORDER_OPEN Instrument契約**: `SwimmyBridge` は `ORDER_OPEN` の `instrument/symbol` に具体シンボルを要求し、`ALL` は `INVALID_INSTRUMENT`、空値と nil-like（`NIL/NULL/NONE`）は `MISSING_INSTRUMENT` として `ORDER_REJECT` で fail-closed する。
- **MT5 ORDER_REJECT 可観測化契約**: Dispatcher は `ORDER_REJECT` を受信したら pending UUID を即時除去する。さらに `reason` が `MISSING_INSTRUMENT/INVALID_INSTRUMENT/MISSING_COMMENT/INVALID_COMMENT_FORMAT/MISSING_STRATEGY/MISSING_TIMEFRAME/INVALID_COMMENT_TF` の場合は運用異常として Discord alert を発火し、受信側 fail-closed を見逃さない。送信側再送（at-least-once）による同一 `id+reason` の短時間重複受信では alert を重複発火しない（idempotent alert）。
- **MT5 Bridge REQ_HISTORY TF正規化契約**: `SwimmyBridge` は `REQ_HISTORY.tf` を大文字小文字非依存で正規化し、`MN/MN1` および minutes文字列（例: `60/240/1440/10080/43200`）を標準TFへ変換する。非標準minutes（例: `300`）は `M1` 配信へフォールバックし、上位層のresampleを前提とする。
- **MT5 Bridge CLOSE_SHORT_TF 保護契約**: `SwimmyBridge` は `POSITION_COMMENT` の `tf_key` を minutes に正規化して `>=1440m`（D1以上）を保護する。旧コメント形式互換のため `|D1`/`|W1`/`|MN`/`|MN1` サフィックス判定も維持する。
- **MT5 Bridge S式受信互換契約**: `SwimmyBridge` の受信パーサは key-value を dot形式 `(<key> . <value>)` と shorthand形式 `(<key> <value>)` の双方で解釈する。`close_all` など真偽値は `true/false`, `t/nil`, `1/0`, `#t/#f` を受理する。
- **Pattern Similarity Service**: 5564(REQ/REP) で **S式のみ**受理。QUERY入力はOHLCVのS式、画像生成はサービス側（バイナリ送信は禁止）。
- **Inference Worker**: 5565(REQ/REP) で **S式のみ**受理（`type="INFERENCE"`）。`SWIMMY_PORT_INFERENCE` でポート上書き可能。
- **Pattern Similarity 実装状態（Phase 1/2）**: `tools/pattern_similarity_service.py` は `STATUS/BUILD_INDEX/QUERY` 契約を提供し、`data/patterns/` の index をロードする。埋め込み backend は `clip-vit-b32`（画像）と `vector-siamese-v1`（学習済みSiamese）を併用可能で、`QUERY` は backend別確率と混合確率を返す。ベクトル学習器は `tools/pattern_vector_dl.py` / `tools/train_pattern_vector_model.py` で管理し、学習済みモデルは `SWIMMY_PATTERN_DL_MODEL_PATH`（既定 `data/patterns/models/vector_siamese_v1.pt`）からロードする。
- **Pattern Similarity Decision Policy**: `QUERY` は `intended_direction`（BUY/SELL）を受け取り、歪み検知（volume/range/price-band concentration）を通過した場合のみ `follow/fade/no-trade` を算出する。`SWIMMY_PATTERN_POLICY_MODE` は `shadow/soft-enforce/full-enforce` を取り、既定は `shadow`（助言のみ、強制停止なし）。
- **Pattern Similarity Ensemble Weight**: `SWIMMY_PATTERN_ENSEMBLE_VECTOR_WEIGHT` は vector backend の混合重み（clip は `1-w`）を表す。2026-02-17 の比較ベンチ結果に基づき、既定値は `0.00`（clip優先）とする。
- **Pattern Backend Auto Calibration**: `tools/pattern_backend_calibration_update.py` が定期ベンチを実行し、`data/reports/pattern_backend_calibration_latest.json`（評価レポート）と `data/patterns/models/ensemble_weight.json`（推奨重み）を更新する。重みファイルは `vector_weight`（global）に加えて `symbol_timeframe_weights`（`<SYMBOL>:<TF>` -> `0.0..1.0` 数値）を持てる。`tools/pattern_similarity_service.py` は `SWIMMY_PATTERN_ENSEMBLE_WEIGHT_FILE`（既定 `data/patterns/models/ensemble_weight.json`）を優先し、`symbol_timeframe_weights` → global `vector_weight` → `SWIMMY_PATTERN_ENSEMBLE_VECTOR_WEIGHT` の順で実行時重みを決定する。
- **Pattern Backend Calibration Health Audit**: `tools/system_audit.sh` は `tools/pattern_backend_calibration_status.py` を呼び出し、`swimmy-pattern-backend-calibration.timer` の有効状態と `data/reports/pattern_backend_calibration_latest.json` の鮮度（既定48時間以内）を監査する。異常時は WARN として可視化する。
- **Pattern DB**: `data/patterns/` に npz + FAISS を保存、SQLiteはメタ情報のみ。
- **時間足データ方針**: M1は **10M candles/シンボル** 保存。M5/M15/M30はM1からリサンプル。H1/H4/D1/W1/MN1は直取得。任意TFは minutes(int) を正本として M1+resample 経路で評価可能にする。
- **Pattern Gate**: H1以上の足確定時に評価、TF一致のみ適用。距離重み確率（k=30 / 閾値0.60）に加えて `decision_action` を実売買側で解釈し、`follow` は不一致時 0.70x、`fade` は 0.55x、`no-trade` は 0.35x へロット減衰する（停止強制は行わず最小ロットで fail-soft）。低歪み局面（`distortion_passed=false`）はノイズ回避のため gate 適用をスキップできる。**ライブ/OOS/CPCV/バックテストに適用**。
- **Signal Confidence Gate**: `process-category-trades` の最終候補シグナルに確度ゲートを適用する。`confidence < 0.20` はエントリー見送り、`0.20 <= confidence < 0.35` はロット `0.55x`、`>= 0.35` は通常ロット。confidence欠落時は後方互換として `1.0` 扱い。
- **ラベル評価幅**: M5/M15=4時間、H1/H4=1日、D1=1週間、W1/MN1=1か月（ATR基準のUp/Down/Flat）。
- **サンプルストライド**: M5=30分(6本)、M15=1時間(4本)、H1/H4/D1/W1/MN1=1本。
- **画像ウィンドウ本数**: M5=120、M15=120、H1=120、H4=120、D1=120、W1=104、MN1=120。
- **VAP**: 価格帯別出来高はMT5ティック由来で生成（**ヒストリカルはData Keeperにティック履歴保存**）。
- **Tick API**: Data Keeper に `GET_TICKS` / `ADD_TICK` を実装し、VAP用のティック履歴を取得できる（newest-first, `start_time/end_time` フィルタ対応）。
- **Backtest Phase方針**: Phase1=2011-2020、Phase2=2021-CSV末尾(rolling end_time)。Backtest要求に `phase`/`range_id` と `start_time`/`end_time` を含める。Evolution Reportに Phase2 end_time を明記する。
- **Startup Liveness**: Brain起動時は「受信ループ（Backtest結果/Guardian stream）」へ先に入る。重い一括処理（Deferred Backtest Flush）は **後回し＋レート制限**で段階的に実行する（起動で詰まらせない）。`SWIMMY_DEFERRED_FLUSH_BATCH`（1回の送信上限、0で無効）と `SWIMMY_DEFERRED_FLUSH_INTERVAL_SEC`（実行間隔秒）で調整する。
- **OOS Queue Startup Cleanup**: 起動時に `oos_queue` を全クリアし、OOS再キューは通常の検証ループで再投入する（古い request_id を残さない）。
- **Brain Bootstrap**: `run.sh` は `brain.lisp` を優先し、欠落時はASDF直起動へフォールバックする。
- **Backtest Option表現**: `Option<T>` は空/1要素リストを正本（例: `(timeframe 1)` / `(timeframe)`）。
- **Backtest Result Contract**: `BACKTEST_RESULT` は常に `request_id` を含める（相関/キュー整合のため必須）。
- **OOS Result Apply Fallback 契約**: `BACKTEST_RESULT` の `-OOS` 結果適用時、受信側は in-memory `find-strategy` 失敗だけで `Strategy not found` としない。`strategies.data_sexp`（DB）から当該戦略を復元できる場合は OOS 指標更新/queue完了/昇格判定を継続し、in-memory と DB の双方で不在のときのみ `oos_queue=error` とする。
- **Backtest Request Contract**: `BACKTEST` 要求は `request_id` を必須とする。`request-backtest-v2`（Phase1 Screening）を含むすべての送信経路で相関IDを付与し、欠落時の `request_id="MISSING"` error結果を通常評価メトリクスとして扱わない。
- **Phase1 Result 名正規化契約**: `BACKTEST_RESULT.result.strategy_name` が `*_P1` の場合、受信側は `"_P1"` を除去した基底名で `apply-backtest-result` / DB更新を行う。`_P1` 結果は RR/QUAL の進捗バッファに加算しない。
- **Backtest Result 末尾サフィックス正規化契約**: `BACKTEST_RESULT.result.strategy_name` の `-RR/-QUAL/-OOS/_P1` 正規化は末尾一致のみで実施する。基底名中の `-QUAL-...` などは削除せず、`<base-with-QUAL-token>-QUAL` のような名称でも基底名を破壊しない。
- **Backtest Bool 正規化契約**: Backtest/CPCV の内部S式で `filter_enabled` などの bool は `#t/#f` を正本とする。`t/nil` シンボルが混入する入力は Backtest Service で正規化して Guardian へ中継する。S式の構文正規化に失敗した場合でも、既知 bool キー（例: `filter_enabled`）はフォールバックで `t/nil`→`#t/#f` へ置換して Guardian へ渡す。
- **Backtest Service 運用整合契約**: `swimmy-backtest.service` を正本とし、systemd が inactive の状態で 5580 に手動 `backtest_service.py` が LISTEN している状態をドリフトとして扱う。監査で検知し、運用に修復を促す。
- **Dashboard Drift 可視化**: `tools/dashboard.py` は `swimmy-backtest` の systemd 状態に加えて 5580 listener と MainPID の整合（drift有無）を表示し、inactive/manual 混在を即時判別できるようにする。
- **Backtest Knob 役割契約**: `SWIMMY_BACKTEST_MAX_PENDING` / `SWIMMY_BACKTEST_RATE_LIMIT` は **Lisp送信側**（`school-backtest-utils.lisp`）のスロットル設定。`SWIMMY_BACKTEST_MAX_INFLIGHT` は **Backtest Service側**（`tools/backtest_service.py`）の並列inflight上限であり、`MAX_PENDING` は service inflight を直接制御しない。
- **Backtest Throttle**: `SWIMMY_BACKTEST_MAX_PENDING` と `SWIMMY_BACKTEST_RATE_LIMIT` で送信抑制。`pending = submit - recv` が上限超過またはレート未達のときは即時送信せず、`backtest-send-queue` に再キューする（キュー容量不足時のみ `:throttled` で拒否）。
- **Backtest Pending Rebase 契約**: `pending = submit - recv` が長時間の部分欠落で過大ドリフトした場合、送信側は `submit` を安全側へリベースして `pending` を上限近傍へ戻す。これにより `pending` が `MAX_PENDING` を恒久的に超え続けて RR/QUAL dispatch が永久停止する状態を防ぐ（結果処理自体は継続）。
- **Backtest Throttle 診断ログ**: throttleログは `pending上限超過` と `rate未達` を原因別に表示する。`pending` だけを表示して rate throttle を誤診しないことを正本とする。
- **Backtest Rate Limit 運用値**: `SWIMMY_BACKTEST_RATE_LIMIT` は運用チューニング対象とし、2026-02-12 時点の適用値は `140`（従来 `100`）。`pending` が低いのに `rate limit` 再キューが連発する場合は段階的に見直す（例: 100→120→140）。
- **Backtest Queue 実装契約**: `backtest-send-queue` の enqueue/dequeue は O(1) を維持する（`length`/`nconc` に依存しない）。高頻度スロットル時にキュー操作コストが送信ループの律速にならないことを正本とする。
- **Backtest Queue 上限設定**: `backtest-send-queue` の容量は `SWIMMY_BACKTEST_SEND_QUEUE_MAX` で調整可能（未指定時は既定値）。運用側で burst 耐性を増やす際はこの値を優先して調整する。
- **Backtest Service Workers**: `tools/backtest_service.py` は複数 Guardian worker を並列起動できる（`SWIMMY_BACKTEST_WORKERS`、既定はCPU数ベースで自動決定）。受信ループは inflight を管理して非同期に結果を返し、`pending` 張り付き時の処理詰まりを緩和する。
- **Backtest Worker/Inflight 運用値**: `SWIMMY_BACKTEST_WORKERS` と `SWIMMY_BACKTEST_MAX_INFLIGHT` は運用チューニング対象。2026-02-13 時点の適用値は `WORKERS=3`, `MAX_INFLIGHT=6`（既定 `4` / `2*workers`）。メモリ圧迫時は worker を先に下げ、throughput低下が許容できない場合のみ段階的に戻す。
- **Deferred Flush pacing**: `flush-deferred-founders` は Backtest レート制限時に送信間隔（`1 / SWIMMY_BACKTEST_RATE_LIMIT` 秒）で dispatch し、同一tick内の即時 `:throttled` 連発による `1件/tick` 近傍への失速を抑制する。
- **RR Batch pacing**: `batch-backtest-knowledge` も受理済み dispatch ごとに送信間隔（`1 / SWIMMY_BACKTEST_RATE_LIMIT` 秒）を挿入し、RRバッチ内で即時 `:throttled` が連発して `Queued: 1` 近傍へ失速するのを抑制する。
- **Backtest Dispatch 計上契約**: RR/QUAL/Deferred/OOS の dispatch 計上は「受理された送信状態」のみ対象とする。`NIL` / `:throttled` は非受理として expected/sent に含めない。
- **Backtest Progress Timeout 契約**: `check-timeout-flushes` による進捗通知は「途中経過」として扱い、RR/QUAL/CPCV の `*_results_buffer` と `*_expected_*` をクリアしない。進捗通知後は `*_start_time*` を更新して、同一進捗の連投スパムを防ぐ。
- **Backtest Progress 可観測性契約**: RR/QUAL の進捗通知は `Progress` 件数だけでなく `Throughput (results/sec)` と `ETA` を併記し、単発スナップショットを「停止/失速」と誤読しないようにする。
- **Backtest Top Results 表示契約**: Discord の `Top Strategy Results` は Sharpe 単独表示にしない。`PF/WR/MaxDD` を同時表示し、A/S未到達の主要因（PF/WR不足）をメッセージ内で即時判読できる形を正本とする。
- **Evolution Top Candidates 表示契約**: Evolution Report の `Top Candidates` は raw Sharpe ではなく trade evidence 補正後 Sharpe（`evidence-adjusted-sharpe`）を主指標として並べる。表示は `S=<adjusted> (raw <raw>)` とし、低頻度戦略の上振れ誤読を防ぐ。
- **Breeder Phase1 必須化**: `add-to-kb` は `source=:breeder` かつ `require-bt=T` の場合、（startup除く）Sharpe値に関わらず `run-phase-1-screening` を必ず要求し、初期ランクを `:incubator` に固定する。Phase1結果でのみ `:B/:graveyard` へ遷移させる。
- **Breeder 呼び出し契約**: `run-breeding-cycle` は Breeder生成物投入時に `add-to-kb(... :source :breeder :require-bt t)` を使用し、運用経路で上記 Phase1 必須化を常時有効にする。
- **Legend交配統合契約**: `run-legend-breeding` の子戦略投入は直接 `push` を禁止し、`add-to-kb(... :source :breeder :require-bt t)` 経由に統一する。Legend由来の子も通常Breeder childと同じ検証フロー（Phase1）を通す。
- **Breeder PF回復圧契約**: 低PF・WR充足ペア（`avg_pf <= 1.15` かつ `avg_wr >= 0.43`）では PF回復モードを強制し、通常の PF bias より高い RR floor と scale floor を適用する。PF不足が主因のカテゴリで Sharpe偏重交配を抑え、PF改善方向を優先する。
- **Breeder 補完ペア距離ゲート契約**: 遺伝距離ゲートは通常ペアを `>=0.03` で維持しつつ、PF/WR 補完ペアは `>=0.01`、partial recovery ペアは `>=0.02` まで緩和する。`indicators=nil` 個体が多い局面で補完交配が `too similar` で飢餓化しないことを正本とする。
- **Scout語彙廃止契約**: 新規作成/デフォルト/フォールバックで `:scout` を生成しない。未移行データ互換として `:scout` は `:incubator` と同等に扱うが、遷移先・表示・保存は `:incubator` を正本とする。
- **B-Rank Culling 保持契約**: `run-b-rank-culling-for-category` は A候補に選ばれなかった B戦略を全量 `graveyard` に送らない。カテゴリごとに少なくとも `*culling-threshold*` 件（または A候補キュー件数の大きい方）を B基盤として残し、超過分のみ prune する。
- **B-Rank Culling 既定閾値**: `*culling-threshold*` の既定値は 20 とし、通常運用ではカテゴリごとの B 基盤を 20 件まで維持する。
- **B-Rank Culling スコア契約**: prune順は Sharpe 偏重にせず、A Stage1 基準（Sharpe/PF/WR/MaxDD）からの欠損度にペナルティを与える。A基準から遠い B を優先的に cull し、A基準に近い B 基盤を残す。
- **B-Rank Culling PF優先契約**: A基準欠損ペナルティは PF不足を最優先で重く扱う（PF欠損 > WR/Sharpe/MaxDD）。Sharpe高値でも PF未達のBが残留し続けるドリフトを抑え、A Stage1 `PF>=1.30` 通過候補の比率改善を優先する。
- **B-Rank Culling PF帯優先契約**: B基盤の保持順は `A PF pass (PF>=1.30)` → `PF near [1.24,1.30)` → `others` を優先し、同一帯内で culling score を比較する。PF帯をまたいで Sharpe 単独で逆転させない。
- **Deferred Flush 制御**: `SWIMMY_DEFERRED_FLUSH_BATCH` で1回のフラッシュ数を制限し、`SWIMMY_DEFERRED_FLUSH_INTERVAL_SEC` でフラッシュ間隔を制御（0は無制限/即時）。
- **Backtest CSV Override**: `SWIMMY_BACKTEST_CSV_OVERRIDE` が設定されている場合、Backtestの `candles_file` は指定パスを優先する。
- **Backtest CSV Override運用例**: `SWIMMY_BACKTEST_CSV_OVERRIDE=/path/to/USDJPY_M1_light.csv` で軽量CSVに差し替える。
- **非相関スコア通知**: A/S昇格時に日次PnL相関から「非相関スコア」を算出しDiscord通知。**非相関はランクではなくポートフォリオ指標**（単一戦略の並びは維持）。
- **Pair Strategy (実装済)**: ペアを**独立エンティティ**としてDB永続化し、選抜ペアのみ overlay に反映する。`pair_strategies` テーブルで `pair_id/構成A/B/weight/評価指標/rank/last_updated` を保持し、`trade_logs` の `pair_id` を引き続き利用する。選抜は **ハイブリッド枠**（シンボル×TFごとに `*pair-slots-per-tf*` 上限、同一ランキングで単一と競争）で実施。昇格ゲートは**OOS合成評価（A）**と**CPCV合成評価（S）**を必須とし、trade_list不足時は昇格不可。trade_listは OOS/CPCV/Backtest の履歴から合成し、CPCVは `CPCV_RESULT` の trade_list 永続化を前提にする。日次 00:10 の PnL 集計後に `refresh-pair-strategies` → `refresh-pair-active-defs` を実行し、DB選抜されたペアのみ `*pair-active-defs*` に反映する。

## 既知のバグ/課題
- **WSL IP**: MT5側の設定 (`InpWSL_IP`) は **空がデフォルト**。手動指定が必須。
- **Backtest Status**: `data/reports/backtest_status.txt` の `last_request_id` と `pending` を監視。
- **Backtest停滞アラート契約**: `Backtest停滞` は pending/inflight が正のときだけ発報する。CPCV-only フェーズや idle（未投入）時は「最終受信時刻が古い」だけでアラートを出さない。
- **Watchdog Silence Timeout契約**: `swimmy-watchdog` の Brain silence 判定は `TIMEOUT_WARN/ BLOCK/ CLOSE` の3段階を維持しつつ、実効値の下限を `120/300/600s` とする。環境値がこれより小さい場合は clamp して運用し、30〜90秒級の通常無通信区間で `BRAIN TIMEOUT` を誤発火させない。
- **Watchdog Startup Grace契約**: `swimmy-watchdog` は `swimmy-brain` の MainPID 変更（再起動）を検知したら、初回 Brain信号を受信するまで startup grace（既定900秒）中は silence timeout 判定を抑止する。起動直後の初期化中に `swimmy-brain` を再キルして再起動ループへ入ることを禁止する。
- **Band Alias Binding契約**: `evaluate-strategy-signal` は `BOLLINGER` を `BB` 同義として扱い、`UPPER-BAND/LOWER-BAND`（および `*-PREV`）を alias 束縛する。`bb-upper/bb-lower` 系と `upper-band/lower-band` 系が混在しても `unbound variable` で評価停止しない。
- **Logic Symbol Package Normalization契約**: `evaluate-strategy-signal` は `entry/exit` ロジック中の参照シンボルを package 非依存で解決する。`COMMON-LISP-USER::SMA-20` や `SWIMMY.TESTS::LOWER-BAND` のような外部packageシンボルでも、同名の評価用束縛へ alias 解決し `unbound variable` で評価停止しない。
- **Signal Candidate Scope契約**: `collect-strategy-signals` は active rank（`:B/:A/:S/:LEGEND`）のみを評価対象にする。`:GRAVEYARD/:RETIRED/NIL` rank は評価ループへ入れず、エラー連打とCPU飽和を抑止する。
- **Legacy Keyword Logic Normalization契約**: `evaluate-strategy-signal` は legacy shorthand（例: `((:RSI-BELOW 10))`, `((:RSI-ABOVE 90))`, `((:CROSS-OVER :SMA 50 :SMA 200))`, `((:CROSS-UNDER ...))`）を正規化してから評価する。`illegal function call`/compile-error ストームを防ぎ、旧Legend定義を fail-open ではなく安全に解釈する。
- **Backtest Debug**: `SWIMMY_BACKTEST_DEBUG_RECV=1` で受信状況を `data/reports/backtest_debug.log` に追記（内部ZMQはS式のみのため、Backtest Serviceの戻りもS式であることが前提）。
- **Backtest Option値**: Guardian `--backtest-only` の `Option<T>` は「空/1要素リスト」で表現（例: `(data_id "USDJPY_M1")` / `(data_id)` / `(start_time 1700000000)`）。
- **データ不整合**: MT5とLisp間のヒストリカルデータ差異。
- **再起動耐性**: Guardianのリスク状態 (`risk_state.json`) の永続化は実装済みだが、クラッシュ時の整合性は要監視。
- **メモリ**: `load-graveyard-cache` はデフォルトのSBCLヒープで枯渇する場合がある（診断時は `--dynamic-space-size 2048` 以上を推奨）。
- **レポート手動更新**: `tools/ops/finalize_rank_report.sh` は `tools/sbcl_env.sh` を読み込み、`SWIMMY_SBCL_DYNAMIC_SPACE_MB`（未指定時 4096MB）で `finalize_rank_report.lisp` を実行する。
- **レポート手動更新（副作用抑制）**: `tools/ops/finalize_rank_report.sh` / `finalize_rank_report.lisp` は既定で「集計のみ（metrics refresh + report generation）」を実行し、rank評価（culling/昇格）は実行しない。rank評価を含める場合は明示的に `SWIMMY_FINALIZE_REPORT_RUN_RANK_EVAL=1` を指定する。

## 直近の変更履歴
- **2026-02-17**: Dispatcher の S式 bool互換契約を追加。`safe-read-sexp` は `#t/#f` を `t/nil` 相当として受理し、`serde_lexpr` 由来メッセージの誤 `Unsafe/invalid SEXP` を抑止する方針を正本化。
- **2026-02-17**: Dispatcher の invalid S式可観測性契約を追加。`Unsafe/invalid SEXP` ログに payload 先頭（`head`）を併記し、再現時に原因メッセージを即時特定できる方針を正本化。
- **2026-02-17**: MT5 `ORDER_REJECT` 可観測化契約を更新。sink-guard fail-closed の Discord alert は維持しつつ、送信側再送による同一 `id+reason` の短時間重複をデデュープして通知スパムを抑止する方針を正本化。
- **2026-02-17**: Evolution Report `Top Candidates` を更新。DB Active候補（Graveyard/Retired除外）を `evidence-adjusted-sharpe` でソートし、表示を `S=<adjusted> (raw <raw>)` に統一。回帰テスト（`test-top-candidates-*`）で検証済み。
- **2026-02-17**: MT5 Bridge の DeadMan 判定順序を更新。`OnTimer` で `:5560` キュー処理を Dead Man's Switch 判定より先に実行し、キュー済み HEARTBEAT 未処理による誤クローズを防ぐ方針を正本化。
- **2026-02-17**: MT5 Bridge の `ORDER_ACK/ORDER_REJECT` 応答到達性を更新。短時間再送で at-least-once 配信を許容し、Dispatcher 側は同一 `id` 重複を idempotent に処理する方針を正本化。
- **2026-02-17**: MT5 Bridge の `REQ_HISTORY` TF正規化契約を追加。`MN/MN1` と minutes文字列TFを標準ENUMへ正規化し、非標準minutesは `M1` 返却＋上位resampleへフォールバックする方針を正本化。
- **2026-02-17**: MT5 Bridge の ORDER_OPEN sink guard 契約を更新。受信 `comment` を `strategy|tf` 形式で再検証し、欠落/形式不正/NIL/不正TFを `ORDER_REJECT` で fail-closed する方針を正本化。
- **2026-02-17**: MT5 Bridge の ORDER_OPEN instrument 契約を更新。実注文で `ALL` を受理せず、`instrument/symbol` が空または nil-like（`NIL/NULL/NONE`）なら `MISSING_INSTRUMENT`、`ALL` なら `INVALID_INSTRUMENT` の `ORDER_REJECT` で fail-closed とする方針を正本化。
- **2026-02-17**: MT5 Bridge の `CLOSE_SHORT_TF` 保護契約を更新。`POSITION_COMMENT` の `tf_key` を minutes 正規化して `D1` 以上を保護し、旧形式 `|D1|W1|MN|MN1` サフィックス判定も後方互換で維持する方針を正本化。
- **2026-02-17**: MT5 Bridge の S式受信互換契約を更新。`(<key> . <value>)` と `(<key> <value>)` の両形式を受理し、bool値として `#t/#f` も解釈する方針を正本化。
- **2026-02-17**: MT5 Bridge command drain 契約を追加。`OnTimer` で `:5560` コマンドを複数件処理し、`HEARTBEAT` を symbol filter 前で受理することで ORDER_OPEN 滞留と DeadMan 誤動作を抑止する方針を正本化。
- **2026-02-17**: Aux service S式パース契約を更新。`parse_sexp_alist` は alist の短縮表記 `(key v1 v2...)` を top-level でも受理し、`(candles (... ) (...))` のような list-cdr 形式を `key -> list-value` として解釈する（`Expected alist at top level` の誤拒否を防止）。
- **2026-02-17**: Executor pending pause 契約を追加。`check-pending-orders` は execution link stale 中に retry/timeout を進めず、リンク断中の `Order Timed Out` 連発を抑止する方針を正本化。
- **2026-02-17**: Rank評価契約を更新。`run-rank-evaluation` に S conformance sweep（既存 `:S` の `check-rank-criteria :S` 再評価）を追加し、基準逸脱Sを `:A/:B` へ自動降格する方針を正本化。
- **2026-02-17**: 既存DBの S不整合ランクを是正。`s_conformance_backup_20260217` へ更新前 `:S` 行を退避し、S staged gate 不合格の `RECRUIT-RND-1768781166-12` を `:B` へ降格（`strategies.rank` 反映）した。
- **2026-02-17**: Test telemetry 隔離契約を拡張。`run-all-tests` だけでなく個別 `deftest` 実行時も telemetry 出力先を `data/memory/swimmy-tests-telemetry*.jsonl` へ固定し、検証用 fail-closed WARN（例: `ORDER BLOCKED ... NIL|M1`）が本番 `logs/swimmy.json.log` へ混入しない方針を正本化。
- **2026-02-17**: Execution link freshness gate 契約を追加。`safe-order` は MT5実行リンク（guardian heartbeat / ACCOUNT_INFO）が stale の間は fail-closed で `ORDER_OPEN` を送らず、pending retry table を増やさない方針を正本化。
- **2026-02-17**: テスト契約を現行ゲート仕様へ整合（A `TradeEvidence>=50` / S `TradeEvidence>=100` / S昇格CommonStage2）。CPCV候補・B-rank culling・promotion通知・evolution report件数の回帰テストを更新し、`test-backtest-trade-logs-insert` は `*disable-auto-migration*` を有効化して DB lock フレークを抑止。実運用ロジックの挙動変更はなし（テスト安定化のみ）。
- **2026-02-17**: `swimmy-watchdog` の timeout 運用契約を更新。`TIMEOUT_WARN/BLOCK/CLOSE` は最小 `120/300/600s` を下回らないよう clamp し、短周期 silence（約30〜90秒）での誤 `BRAIN TIMEOUT` / 不要な `swimmy-brain` 再起動ループを抑止する方針を正本化。
- **2026-02-17**: `swimmy-watchdog` の startup grace 契約を追加。`swimmy-brain` の MainPID 変更後、初回 Brain信号受信までは既定900秒の猶予を設け、起動直後の silence を timeout 判定しない方針を正本化。
- **2026-02-17**: Strategy signal 評価契約を更新。`BOLLINGER` を `BB` 同義で正規化し、`UPPER-BAND/LOWER-BAND` alias 束縛（`*-PREV` 含む）を追加して、`Hunted-BB-Reversion` 系の `LOWER-BAND is unbound` を防ぐ方針を正本化。
- **2026-02-17**: Strategy signal の symbol package 正規化契約を追加。`entry/exit` が `COMMON-LISP-USER::*` や他packageの指標シンボル（例: `SMA-20`, `BB-LOWER`, `UPPER-BAND`）を含んでも、評価器は同名束縛へ alias 解決して `unbound variable` を防ぐ方針を正本化。
- **2026-02-17**: Signal candidate scope 契約を追加。`collect-strategy-signals` は active rank（`:B/:A/:S/:LEGEND`）のみを評価し、graveyard/retired/NIL rank を live 評価ループから除外してログストームとCPU過負荷を防ぐ方針を正本化。
- **2026-02-17**: Legacy keyword logic 正規化契約を追加。`evaluate-strategy-signal` は `((:RSI-BELOW ...))` / `((:RSI-ABOVE ...))` / `((:CROSS-OVER ...))` / `((:CROSS-UNDER ...))` 形式を canonical logic へ変換してから評価し、`illegal function call` を起点とした compile-error 連鎖を防ぐ方針を正本化。
- **2026-02-17**: Timeframe canonical 契約を更新。内部表現を minutes(int) に統一し、既定8TFバケットを維持しつつ任意TF探索（例: M36/H2/H5/H60）を許容する方針を正本化。カテゴリ/相関/Pattern Gate は有限バケットへ正規化し、TF mutation pool は pending 圧で budget 制御する。
- **2026-02-17**: Rank TradeEvidence floor 契約を追加。A `>=50`、S `>=100` を必須化し、`run-rank-evaluation` の floor sweep（`S<100` 降格、`A<50` 降格）と `evaluate-a-rank-strategy` の未達即時降格を正本化。
- **2026-02-17**: 低頻度Sharpe過大評価の統計ドリフト対策を更新。Guardian の Sharpe 算出は 0 リターン日を除外せずに計算し、trade evidence が薄い戦略は rank/score で上振れしにくくする方針を正本化。
- **2026-02-17**: 既存DBのA/S証拠不足ランクを一括是正。`trade_floor_backup_20260217` を退避後に `S<50 -> B`、`50<=S<100 -> A`、`A<50 -> B` を適用し、`strategies.rank` と `data_sexp` の rank 表記を同期した。
- **2026-02-17**: Backtest停滞アラート契約を更新。`maybe-alert-backtest-stale` は pending/inflight が正のときのみ通知し、CPCV-only/idle で `Backtest停滞` を誤送信しない方針を正本化。
- **2026-02-17**: Guardian CPCV のメモリ契約を更新。`CPCV_VALIDATE` は 1リクエストにつき CSV全件ロードを1回に限定し、path/range ごとの再読込を行わない（同一バッファ再利用）方針を正本化。
- **2026-02-17**: Indicator type 正規化契約を追加。`strategy.indicators` の type が `sma` / `:SMA` / `"sma"` のように package や表現が混在しても、評価器は同一指標として解釈して束縛を生成する。`SMA-20` などの unbound で評価停止しない。
- **2026-02-17**: Logic 参照指標の補完契約を追加。`strategy.indicators` と `entry/exit` の期間参照（例: `SMA-20`）が不整合でも、評価器は参照された period 指標を history から補完束縛し、`SMA-20` unbound で評価停止しない。補完対象は `SMA/EMA/RSI/CCI/ATR/WILLIAMS` の `-<period>` と `-<period>-PREV`。
- **2026-02-17**: Logic symbol alias 解決契約を拡張。`evaluate-strategy-signal` は package/case 混在の参照シンボルをシンボル名ベースで正規化して束縛解決し、`SWIMMY.TESTS::SMA-20` やエスケープ小文字（例: `|sma-20|`, `|lower-band|`）でも unbound で評価停止しない。
- **2026-02-17**: Strategy indicator 評価契約を更新。`evaluate-strategy-signal` / `get-indicator-values` は `williams` 指標を正式サポートし、`WILLIAMS`（および period 付き変数）を常に束縛できることを正本化。`SWIMMY.SCHOOL::WILLIAMS` の unbound で評価停止しない。
- **2026-02-17**: Bollinger パラメータ正規化契約を追加。`(bb period)` のように偏差が欠落した指標は `dev=2.0` を既定補完して評価し、`NIL is not of type NUMBER` を起こさない。
- **2026-02-17**: Guardian Dead-Man timeout の運用契約を再更新。`BRAIN_TIMEOUT_SECS` は SPEC/INTERFACES と整合する `300s` を正本とし、さらに「初回 Brain motor signal 受信前」は startup grace（既定 900s）中の silence を timeout 判定しない方針を追加。長時間コールドスタート中の誤 `BRAIN DEAD DETECTED` / 不要な `swimmy-brain` restart を抑止する。
- **2026-02-17**: Guardian の Dead-Man timeout 判定契約を更新。`sub_from_brain` に未処理メッセージがあるループでは `BRAIN_TIMEOUT_SECS` 超過でも即時 Dead 判定しない（受信優先）。これにより、CPCV/Backtest の重い処理中に heartbeat がキュー済みでも `BRAIN DEAD DETECTED`/`AUTO-REVIVAL HALTED` を誤発火させない方針を正本化。
- **2026-02-17**: fail-closed 可観測性契約を追加。実行文脈欠落で注文を中止した際に Discord alert と `execution.context_missing` telemetry を出力する方針を正本化。
- **2026-02-17**: Execution fail-closed 契約を追加。`strategy_name/timeframe` が欠落した注文は `NIL`/既定TFへフォールバックせず中止し、文脈不整合を早期に顕在化させる方針を正本化。
- **2026-02-17**: ORDER_OPEN コメントの実行文脈契約を更新。`process-category-trades` で選抜したトップ戦略の `strategy_name/timeframe` を実行経路へ引き渡し、`NIL|M1` のような文脈欠落コメントを送信しない方針を正本化。
- **2026-02-17**: 実行時時間足の厳格パース契約を追加。`"NIL"`/空文字/未知ラベルの `timeframe` は `M1` へ丸めず、`execution.context_missing` を出して fail-closed で注文中止する。
- **2026-02-17**: ORDER_OPEN の sink guard 契約を拡張。`safe-order` に加えて `make-order-message` でも `comment` を厳格検証し、`strategy|tf` 形式を満たさない（`NIL` 含む）注文は MT5 送信前に fail-closed で中止する方針を正本化。
- **2026-02-17**: MT5 ORDER_OPEN 受信ガード契約を追加。`SwimmyBridge` は `comment` 欠落/形式不正/`NIL`/不正TF を `SW-<magic>` へフォールバックせず `ORDER_REJECT`（`MISSING_COMMENT/INVALID_COMMENT_FORMAT/MISSING_STRATEGY/MISSING_TIMEFRAME/INVALID_COMMENT_TF`）で fail-closed する方針を正本化。
- **2026-02-17**: Executor pending の運用契約を更新。MECU exposure 計算で pending `ORDER_OPEN` を `instrument/side/lot` で解釈し、`ORDER_ACK` 受信時に該当UUIDを `swimmy.globals:*pending-orders*` から除去する方針を正本化。
- **2026-02-17**: MT5 reject 応答契約を追加。MT5 が注文拒否時に `ORDER_REJECT`（`id`/`symbol`/`reason`/`retcode`）を返し、Dispatcher は `ORDER_REJECT` 受信時も該当UUIDを `swimmy.globals:*pending-orders*` から即時除去して timeout リトライ残留を防ぐ方針を正本化。
- **2026-02-17**: MT5 reject 可観測化契約を拡張。Dispatcher は `ORDER_REJECT.reason` が fail-closed 系（`MISSING_INSTRUMENT/INVALID_INSTRUMENT/MISSING_COMMENT/INVALID_COMMENT_FORMAT/MISSING_STRATEGY/MISSING_TIMEFRAME/INVALID_COMMENT_TF`）の場合に Discord alert を発火し、受信側 fail-closed の発生を運用面で即時検知できるようにする。
- **2026-02-17**: XAU AutoBot の運用契約を更新。`Swimmy-XAU-Cycle` の成功は「最適化成功」であり実注文稼働を意味しないことを明確化。実注文の健全判定は `xau_autobot.py --loop --live` 常駐（Exec task または Startup launcher）を正本とし、`-Live` 抜けを停止要因として扱う方針を追加。
- **2026-02-17**: Pattern Similarity の運用契約を更新。`QUERY` に `intended_direction`（BUY/SELL）を追加し、service側で `follow/fade/no-trade` の decision を返す方針を正本化。`SWIMMY_PATTERN_POLICY_MODE` 既定値は `shadow`（助言のみ、強制停止なし）とする。
- **2026-02-17**: Pattern Similarity の実装契約を更新。backend は `clip-vit-b32` と `vector-siamese-v1` の併用を正本化し、低歪み局面（volume/range/price-band concentration が弱い）は gate 適用をスキップしてノイズ照合を抑制する方針を追加。
- **2026-02-17**: Pattern backend 比較ベンチ（`data/reports/pattern_backend_benchmark_2026-02-17.json`）の結果を反映し、`SWIMMY_PATTERN_ENSEMBLE_VECTOR_WEIGHT` の既定値を `0.00`（clip優先）へ更新。
- **2026-02-17**: Pattern backend 自動校正契約を追加。`tools/pattern_backend_calibration_update.py` + `swimmy-pattern-backend-calibration.timer` により定期ベンチを実行し、`data/patterns/models/ensemble_weight.json` を更新して service 側へ動的反映する方針を正本化。
- **2026-02-17**: Pattern backend 校正の監査契約を追加。`tools/system_audit.sh` に `tools/pattern_backend_calibration_status.py` を統合し、timer 有効性と calibration report 鮮度（既定48時間）を WARN 監査する方針を正本化。
- **2026-02-17**: Pattern backend 重み適用契約を拡張。`ensemble_weight.json` の `symbol_timeframe_weights`（`<SYMBOL>:<TF>`）を導入し、QUERY時の重み決定を `symbol+timeframe` 単位で上書き可能にした。
- **2026-02-17**: Pattern backend 運用実装を更新。`pattern_backend_calibration_update.py` が `ensemble_weight.json` に `symbol_timeframe_weights` を出力し、`pattern_similarity_service.py` の `STATUS/QUERY` レスポンスに重み適用情報（default file path / applied weight / weight_source）を返す方針を正本化。
- **2026-02-17**: Pattern Gate 実行ポリシーを更新。Lisp実売買側は `decision_action` を解釈し、`follow/mismatch=0.70x`、`fade=0.55x`、`no-trade=0.35x` の段階減衰を適用する（強制停止ではなく fail-soft）。あわせて telemetry に `vector_weight_applied/weight_source` を記録し、symbol+timeframe 重みの実適用を追跡可能にする。
- **2026-02-14**: Brain/Guardian の auto-revival（`swimmy-guardian` / `swimmy-watchdog`）は `systemctl restart` が polkit で `Interactive authentication required` になる環境を想定し、**まず** `sudo -n /usr/bin/systemctl restart <unit>` を試す。成功すれば SIGTERM フォールバックを使わずに復旧できる（flapping/進捗リセットを抑制）。`sudo -n` が使えない場合/許可が無い場合は従来通り `systemctl show -p MainPID --value` → `SIGTERM`（必要時 `SIGKILL`）で MainPID を落とし、systemd の `Restart=` で復旧させる。
- **2026-02-14**: passwordless `systemctl` 運用を `/etc/sudoers.d/swimmy-systemctl`（`restart/status/is-active` を unit 限定で許可）で提供する方針を追加。テンプレートは `tools/ops/swimmy-systemctl.sudoers`、インストールは `sudo bash tools/ops/install_swimmy_systemctl_sudoers.sh` を正本とする。
- **2026-02-14**: Polymarket OpenClaw status の運用契約を更新。cycle timer が無効なとき、status ファイルが更新されず stale になるのは仕様のため `Health: disabled` として扱い、`--fail-on-problem` でも exit 0 とする方針へ更新。
- **2026-02-14**: Archive drift の表示契約を更新。Library の GRAVEYARD/RETIRED raw dir count は overlap により二重計上されるため、drift 判定を canonical(unique-name) に統一し、`delta(DB-LibraryCanonical)` と `overlap` を併記する方針へ更新。
- **2026-02-13**: BACKTEST_RESULT 適用の数値メトリクス耐性を追加。`metrics` がキー存在でも値が `NIL` の場合は `0.0/0` として正規化し、`The value NIL is not of type REAL` で受信ループが落ちないことを正本化。
- **2026-02-13**: `Msg Error` 可観測性を強化。message-dispatcher の例外ログに `head`（先頭プレビュー）と `step`（ブレッドクラム）を付与し、原因メッセージ/経路を同定できるように更新。
- **2026-02-13**: Allocation の pending 管理を修正。executor の `swimmy.globals:*pending-orders*`（UUID→(ts,retry,msg)）と School の warrior slot 用 pending を分離し、`check-pending-timeouts` が誤って retry table を走査して `NIL is not of type REAL` を起こす不具合を解消（`*allocation-pending-orders*` 導入）。
- **2026-02-13**: PF/WR mutation bias の S-target を追加。両親が A-rank 以上のときは S基準（PF=1.70/WR=0.50）を mutation bias のターゲットとして扱い、A基準達成後も S readiness を探索圧として維持する。
- **2026-02-13**: Graveyard Avoidance の運用契約を更新。`analyze-graveyard-for-avoidance` は graveyard.sexp の破損フォームで中断せずスキップ継続し、`SWIMMY_GRAVEYARD_AVOID_CACHE_SEC` によるTTLキャッシュで child 生成ごとの全走査を防ぐ方針を追加。
- **2026-02-13**: `migrate-existing-data` の graveyard 読み込み契約を更新。`read` 一括読込で破損行に遭遇すると migration 全体が停止するため、行単位 `safe-read-sexp` に変更し、破損行をスキップして継続する方針を追加。
- **2026-02-13**: `collect-all-strategies-unpruned` の計算量契約を更新。DB+Library の重複除外を線形探索から `strategy_name` ハッシュ集合へ変更し、O(n) で統合する方針を追加。
- **2026-02-13**: OOS結果適用のフォールバック契約を追加。`handle-oos-backtest-result` は in-memory miss でも DB（`strategies.data_sexp`）復元を試み、両方不在時のみ `Strategy not found for OOS result` を記録する方針を明記。
- **2026-02-13**: `strategies` テーブルの検索最適化契約を追加。`idx_strategies_rank_sharpe` と `idx_strategies_category_rank` を `init-db` で必須作成し、ランク/カテゴリ条件の抽出を高速化する方針を明記。
- **2026-02-13**: Backtest pending カウンタの運用契約を更新。`submit-recv` の過大ドリフト時に送信側で安全リベースして `MAX_PENDING` 張り付きによる永続停止を回避する方針を追加。
- **2026-02-13**: BACKTEST_RESULT 名正規化契約を強化。`-RR/-QUAL/-OOS/_P1` は末尾一致のみで除去し、基底名中の `-QUAL-...` を誤って切り落とさない方針を追加。
- **2026-02-13**: `tools/evolution_daemon.py` の排他運用契約を更新。起動後に `swimmy-school` が立ち上がった場合でも evolution 子SBCLを停止して待機へ戻し、二重の `start-evolution-service` ループを継続しない方針を追加。
- **2026-02-13**: School Connector の Wisdom 実行を間隔制御へ変更。`SWIMMY_WISDOM_UPDATE_INTERVAL_SEC`（既定1800秒）を導入し、`phase-7-wisdom-update` が毎サイクルで `analyze-veterans` を実行しない方針を追加。
- **2026-02-13**: `analyze-veterans` の処理契約を更新。de-dup/filter/sort を単一パス化し、`Top-N`（50件）のみ保持する実装へ変更して Wisdom 抽出時のピークメモリを削減。
- **2026-02-13**: Breeder の補完ペア距離ゲートを調整。`*breeder-min-genetic-distance-complement*=0.01`、`*breeder-min-genetic-distance-partial-recovery*=0.02` を正本化し、`Dist 0.01-0.02` 帯で補完交配が継続的に reject される停滞を緩和する方針を追加。
- **2026-02-13**: Breeder の低PF回復圧を強化する方針を追加。`avg_pf<=1.15 && avg_wr>=0.43` のペアで PF回復モード（RR floor/scale floor 強化）を適用し、PF不足停滞の打破を優先する契約を追記。
- **2026-02-13**: Breeder の WR補完判定を動的化。親PF余剰と候補WR余剰に応じて `WR-complement` の最低PF閾値を `1.18 -> max(1.08, 動的閾値)` へ緩和し、`PF-only x 高WR` の有効ペアを取りこぼさない方針を追加。
- **2026-02-13**: PF回復の上位ターゲット圧を追加。`avg_wr>=0.47` かつ `avg_pf<1.70` の WR-ready ペアに `upside scale floor` を適用し、A基準達成済みでも S基準PFへ寄せる探索圧を維持する方針を追記。
- **2026-02-13**: B-Rank culling の保持順を PF帯優先へ更新。`PF>=A基準` → `PF near` → `others` の順に保持候補を選び、同帯内のみ culling score で並べる方針を追加。
- **2026-02-13**: `tools/system_audit.sh` の systemd監査を強化。`sudo -n` が使えない環境でも `systemctl` 直実行へフォールバックして状態確認を継続し、監査自体を `skipping systemctl status` で欠落させない方針を追加。
- **2026-02-13**: `tools/system_audit.sh` の監査契約を更新。`swimmy-pattern-similarity` は unit 未登録でも実プロセス + `:5564` LISTEN を fallback 健全判定として扱い、`Interactive authentication required` 発生時の auto-repair は WARN スキップで監査継続する方針を追加。
- **2026-02-13**: Dashboard のサービス表示契約を更新。`PatternSim` は systemd unit 未登録時でも fallback 健全判定（実プロセス + `:5564` LISTEN）を表示に反映し、運用者が実稼働を誤認しない方針を追加。
- **2026-02-13**: `tools/deep_audit.lisp` をストリーミング監査へ更新。archive-heavy DB でも `init-knowledge-base` を呼ばず、DB/Library のランク集計と `data_sexp` のサンプル復元で健全性を確認する方針へ変更。
- **2026-02-13**: `backtest_status.txt` の保存先を `swimmy.main::*backtest-status-path*` へ抽象化。テストは一時ファイルへバインドし、本番 `data/reports/backtest_status.txt` を汚染しない方針へ更新。
- **2026-02-12**: Evolution Report の `System Status` 契約を更新。`Evolution Daemon Active` を固定表示せず、systemd実状態（`swimmy-evolution.service`）を反映し、`systemctl` 取得不能時のみ heartbeat 補助判定へ切替える方針を追加。
- **2026-02-12**: Evolution Report の表示整形契約を更新。`CPCV Stage2` / `A Near-Miss` の `%` が `%%` で出る退行を修正し、A Near-Miss の同名戦略重複表示を抑制する方針を追加。
- **2026-02-12**: Evolution Report の候補名短縮契約を更新。先頭25文字のみの省略で同名衝突が発生するため、先頭+末尾を保持する短縮表示へ統一する方針を追加。
- **2026-02-12**: Evolution Report に Validation Coverage（OOS/CPCVのDB累計、全体/Active）を追加する方針を追記。`CPCV Status` の瞬間値だけでは実行実績を誤読しやすい点を補正する。
- **2026-02-13**: Evolution Report に A Gate Pressure（Active B の A Stage1 ゲート通過件数/PF近傍帯）を追加する方針を追記。Sharpe高値でも A/S が 0 のとき、Stage1（特に PF）詰まりを即時判読できるようにする。
- **2026-02-13**: B-Rank culling の A基準欠損ペナルティを PF優先へ調整する方針を追記。PF不足を WR/Sharpe/MaxDD より重く扱い、`pass_all=0` 停滞時の PF ボトルネック解消を優先する。
- **2026-02-12**: Backtest throttle の診断ログ契約を追加。`pending` 超過と `rate` 未達を原因別にログ表示し、`pending=1/max=3000` のような rate 由来 throttled を誤解しない運用へ更新。
- **2026-02-12**: Backtest の運用レート上限を段階調整。`SWIMMY_BACKTEST_RATE_LIMIT` を `100→120→140` に更新し、`pending` 低位でも `rate limit` 再キューが発生するボトルネックを緩和する方針を追加。
- **2026-02-12**: Backtest Service worker 数を運用調整。`SWIMMY_BACKTEST_WORKERS` を `4→6` へ引き上げ、`pending` が低位でも結果反映が断続的に止まる状況のスループット改善を狙う方針を追加。
- **2026-02-13**: Backtest Service worker 数を追加調整。`SWIMMY_BACKTEST_WORKERS` を `6→8` へ引き上げ、CPU/メモリ余力を使って RR バッチの処理密度を高める運用へ更新。
- **2026-02-13**: メモリ圧迫対応として Backtest knobs を再調整。`SWIMMY_BACKTEST_WORKERS` を `8→3`、`SWIMMY_BACKTEST_MAX_INFLIGHT=6` を明示し、`MAX_PENDING`（Lisp送信側）と `MAX_INFLIGHT`（Service側）の役割を分離して運用する方針を追加。
- **2026-02-13**: Breeder生成物のPhase1スクリーニング契約を強化。`add-to-kb(source=:breeder, require-bt=T)` は Sharpe値に依存せず `run-phase-1-screening` を必須化し、初期ランクを `:incubator` として非検証の即時B昇格を抑止する方針を追加。
- **2026-02-13**: Breeder運用経路を契約に再整合。`run-breeding-cycle` から `add-to-kb` 呼び出しは `:require-bt t` を正本とし、実運用で Breeder child が必ず Phase1 screening を経由する方針を追加。
- **2026-02-13**: Legend交配統合契約を追加。`run-legend-breeding` で生成される子戦略も `add-to-kb(:breeder :require-bt t)` に統一し、直接KB投入による検証スキップを禁止する方針を明記。
- **2026-02-13**: Scout語彙廃止契約を追加。新規ランク生成/フォールバックを `:incubator` へ統一し、旧 `:scout` は後方互換としてのみ受理する方針を明記。
- **2026-02-13**: BACKTEST_RESULT の `_P1` サフィックス正規化契約を追加。Phase1結果を基底戦略名へ正規化してDB反映し、RR/QUAL進捗集計への混入を防止する方針を追記。
- **2026-02-13**: Backtest Request の `request_id` 必須契約を更新。`request-backtest-v2`（Phase1）が `request_id` なしで送信されると Backtest Service で `request_id="MISSING"` error結果となるため、送信時に相関IDを必須付与する方針を明記。
- **2026-02-13**: Backtest/CPCV の timeout 進捗通知契約を更新。途中経過通知ではバッファ/expectedを破棄せず保持し、進捗スナップショット後に start時刻だけ更新して重複通知スパムを抑制する方針を追加。
- **2026-02-13**: Backtest進捗通知の可観測性契約を拡張。RR/QUAL通知に Throughput/ETA を追加し、Top Strategy Results へ PF/WR/MaxDD を併記して Sharpe単独誤読を抑止する方針を追記。
- **2026-02-13**: Evolution Report の `Source Drift` 表示を補強。Graveyard/Retired mismatch に `delta(DB-Library)` を付与し、ドリフト方向（DB余剰/Library余剰）を明示する方針を追加。
- **2026-02-13**: `reconcile_archive_db.py` に `--grace-sec` を実装。`mtime > (scan_start - grace_sec)` の archive ファイルを当該実行から除外し、稼働中レースで `wrong_rank` が揺れ続ける問題を抑制する（既定 `0` は無効）。
- **2026-02-12**: `finalize_rank_report` の運用契約を更新。既定動作を集計専用（rank変更なし）にし、`SWIMMY_FINALIZE_REPORT_RUN_RANK_EVAL=1` 指定時のみ rank評価を実行する方針を追加。
- **2026-02-12**: 最終エントリー前に Signal Confidence Gate を追加。低確度シグナルは見送り、中確度シグナルはロット縮小（0.55x）で実行し、無差別エントリーを抑制する方針を明記。
- **2026-02-12**: Dashboard の backtest欄に systemd/listener drift 可視化を追加する方針を追記。`inactive + listener` や PID mismatch を画面上で即時判読可能にする。
- **2026-02-12**: `swimmy-backtest` の systemd運用ドリフト検知方針を追加。`inactive + manual 5580 LISTEN` を監査FAIL扱いにし、systemd正本への復帰を促す。
- **2026-02-12**: Backtest Service の S式正規化を強化する方針を追加。`(strategy (k . v) ...)` などの短縮表現を含むBACKTEST要求でも bool を `#t/#f` へ正規化して Guardian へ転送し、`invalid type: symbol, expected boolean` を防止する。
- **2026-02-13**: Backtest Service の bool 正規化フォールバックを追加する方針を追記。S式 parse 正規化が失敗するケースでも、既知 bool キーの `t/nil` を `#t/#f` へ保守的に置換して Guardian parse error を抑止する。
- **2026-02-13**: `reconcile_archive_db.py` の運用を拡張。DB-only archive drift の件数を常時表示し、`--prune-db-only` 指定時はバックアップテーブル退避後に prune 可能とする方針を追記。
- **2026-02-12**: B-Rank culling の既定閾値を 20 へ引き上げる方針を追加。カテゴリごとの B 基盤を 20 件まで維持する運用へ変更。
- **2026-02-12**: B-Rank culling の prune順を A基準欠損ペナルティ込みへ更新する方針を追加。Sharpe偏重で A基準から遠いBが残るドリフトを抑制する。
- **2026-02-12**: Backtest Service の実行モデルを並列worker対応に拡張する方針を追加。`SWIMMY_BACKTEST_WORKERS` で Guardian `--backtest-only` の並列数を制御し、inflight 非同期処理で `pending` 上限張り付き時のスループット低下を緩和する。
- **2026-02-12**: B-Rank culling の保持契約を追加。A候補以外を全量 graveyard 化する挙動を廃止し、カテゴリごとのB基盤（`*culling-threshold*` 件以上）を保持したうえで超過分のみ prune する方針を明記。
- **2026-02-12**: Backtest送信キューの実装契約を更新。`length`/`nconc` 依存を廃止し O(1) キュー運用を正本化、あわせて `SWIMMY_BACKTEST_SEND_QUEUE_MAX` による容量調整方針を追加。
- **2026-02-12**: Evolution/Backtest系レポートに A Stage1 基準の不合格内訳（Sharpe/PF/WR/MaxDD）を常時表示する方針を追加。
- **2026-02-12**: Evolution Report に A Near-Miss（Bランク上位）表示を追加する方針を追記。`a-base-deficit-score` が小さい順に候補を提示し、各候補の不足ゲート（Sharpe/PF/WR/MaxDD）を併記して A/S 停滞の原因を即時確認できるようにする。
- **2026-02-12**: RR Backtest Batch の送信をレート制限に同期。受理済み dispatch ごとに `1 / SWIMMY_BACKTEST_RATE_LIMIT` 秒の間隔を挿入し、同一バッチ内 `:throttled` 連発で `Queued: 1` 近傍に張り付く失速を抑制する方針を追加。
- **2026-02-12**: Deferred Founder Backtest Flush の送信をレート制限に合わせて間隔化（`1 / SWIMMY_BACKTEST_RATE_LIMIT` 秒）。同一tickで `:throttled` が連発して `Deferred BT sent` が実質 `1件/tick` になる失速を抑制する方針を追加。
- **2026-02-12**: `request-cpcv-validation` の送信S式キーを正規化（`action/strategy_name/candles_file/request_id/strategy_params` を package 非依存で出力）し、呼び出し元 `*package*` による `swimmy.school::action` 形式のドリフトを防止する方針を追加。
- **2026-02-12**: Telemetry ログ書き込みを耐障害化。主要ログの Permission denied / rotate 競合時に `data/memory/swimmy.telemetry.fallback.jsonl` へ退避するフォールバックを追加し、`run-all-tests` は telemetry 出力先を `data/memory/` 配下へ隔離して運用ログとの競合を避ける方針を明記。
- **2026-02-12**: `systemd/swimmy-school.service` に `User=swimmy` / `Group=swimmy` を明示し、systemd正本ユニットの実装を STATE の運用方針（非root実行）に再整合。
- **2026-02-12**: AランクWR下限の実装ドリフトを修正。`school-rank-system` / Evolution Report文言 / 単体テスト / 運用ドキュメントを `WR>=43%` に統一し、`WR>=38%` 例外を撤廃。
- **2026-02-12**: Evolution Report 保存の実装契約を修正。`write-evolution-report-files` が `*evolution-report-path*` を正本に使用し、テスト実行時の固定パス上書きドリフトを防止する方針を追加。
- **2026-02-12**: `run-all-tests` のレポート出力隔離を追加。`*evolution-report-path*` を `data/memory/swimmy-tests-evolution-report.txt` へバインドし、テストで本番 `evolution_factory_report.txt` が上書きされないように修正。
- **2026-02-11**: Backtest送信の計上契約を強化。スロットル時は可能な限り再キューし、RR/QUAL/Deferred/OOS の expected/sent は `NIL/:throttled` を除外して計上するよう方針を明文化。
- **2026-02-11**: AランクのWR下限を正本（SPEC/STATE）へ再整合する方針を確定。`WR>=43%` を単一の運用基準とし、実装側の `38%` 例外を廃止。
- **2026-02-11**: Dynamic Drawdown Alert の Peak 金額表示を整数表記へ統一し、`¥1000000.` のような末尾小数点が Discord 通知に出ないよう修正（`DYNAMIC DRAWDOWN WARNING` の文面整形）。
- **2026-02-11**: Executor の heartbeat pulse 表示 `Equity` を整数表記へ統一し、`Equity: 1000000.` のような末尾小数点を解消。
- **2026-02-11**: Executor/Risk の円建てログ表記を追加整合。`MT5 Sync`、`EQUITY UNKNOWN OR ZERO` fallback、`DAILY LOSS LIMIT HIT` の金額表示を整数表記へ統一し、末尾小数点を除去。
- **2026-02-11**: 円建て表示の追加整合を拡張。Heartbeat summary、Trade close fallback通知、Global Stats PnL、Darwin daily toxic ログの金額表示も整数表記へ統一し、末尾小数点を除去。
- **2026-02-11**: School heartbeat 更新をサイクル完了依存から独立tickへ変更。`run-stagnant-flush-tick` で `data/heartbeat/school.tick` を更新し、長時間フェーズ実行中の `Evolution report/heartbeat stale` 誤検知を抑制。
- **2026-02-11**: Pattern Similarity の Phase 2（ベクトル深層学習）を追加。`tools/pattern_vector_dl.py` と `tools/train_pattern_vector_model.py` を実装し、service側で学習済み Siamese チェックポイントを自動ロードして `model=vector-siamese-v1` を返せるように更新。未配置時は `vector-fallback-v1` へフォールバック。
- **2026-02-11**: Data Keeper の Tick API（`ADD_TICK` / `GET_TICKS`）を実装。`tools/test_data_keeper_sexp.py` に契約テスト（追加/取得/時間窓）を追加。
- **2026-02-11**: Lisp Core に Pattern Similarity client を追加（`SWIMMY_PORT_PATTERN_SIMILARITY` / 既定5564）。`school-execution` に H1+ のソフトゲート（不一致時 lot 0.7x）を接続し、`execution.pattern_gate` telemetry を追加。
- **2026-02-11**: Pattern Similarity Service (5564) の Phase 1 実装を追加。`tools/pattern_similarity_service.py`、`systemd/swimmy-pattern-similarity.service`、`tools/test_pattern_similarity_sexp.py` を追加し、`tools/install_services.sh` / `tools/system_audit.sh` にサービス反映。
- **2026-02-11**: `upsert-strategy` に Archive Rank 保護を追加し、DB既存 `:GRAVEYARD/:RETIRED` が通常upsertで `NIL/Active` に戻る退行を防止。
- **2026-02-11**: OOS dispatch の成否契約を厳格化。Backtest送信が受理されなかった要求を `sent` に残さず `error` 化し、`oos_status` の `sent/pending` 誤増加を抑制。
- **2026-02-11**: OOS status 表示のダミー値を廃止。`data/send/db` の失敗内訳と latency(avg/min/max) を実測から表示するよう更新。
- **2026-02-11**: CPCV status の `failed` を内訳表示（`send_failed/result_failed(runtime/criteria)`）に拡張し、ゲート未達と実行系エラーを区別可能にした。
- **2026-02-11**: CPCV受信結果の分類を強化し、`path_count/passed_count/failed_count=0` の空結果を `runtime` 失敗として扱うように更新。未知戦略名の CPCV 個別通知を抑制して `Strategy: AAA` ノイズ通知を防止。
- **2026-02-11**: ランク判定を `Balanced + 2段階ゲート` に更新する方針を確定。Stage 1固定閾値（B/A/S）を引き上げ、Stage 2に OOS/CPCV/MC/DryRun を組み合わせる昇格ゲートを正本化。
- **2026-02-11**: ランク昇格ロジックを実装更新。A昇格に `Expectancy>0` を追加し、A/S共通で `MC prob_ruin<=2%` と `DryRun p95(slippage)<=max_spread` を必須化。`TRADE_CLOSED` のスリッページ計測を戦略単位で蓄積して DryRun ゲートに接続。
- **2026-02-11**: DryRunスリッページの永続化を追加。`dryrun_slippage_samples` を導入し、戦略ごとの最新サンプル保持（既定200件）と再起動後のゲート継続を実装。
- **2026-02-11**: DryRunスリッページ永続化に期間保持（TTL）を追加。`*dryrun-slippage-max-age-seconds*` が正値のとき、`dryrun_slippage_samples` の保持期間外サンプルを戦略単位で削除する。
- **2026-02-11**: `systemd/swimmy-guardian.service` の再起動ポリシーを強化（`Restart=always`、`StartLimitIntervalSec=300`、`StartLimitBurst=5`）。
- **2026-02-11**: `swimmy-guardian` の Brain auto-revival を強化。`systemctl restart swimmy-brain` が失敗した場合に `systemctl show -p MainPID --value swimmy-brain` → `SIGTERM`（必要時 `SIGKILL`）で MainPID を落とし、systemd の `Restart=` で復旧させるフォールバックを追加。
- **2026-02-11**: Guardian の `CPCV_VALIDATE` S式パーサでキー正規化を強化。`swimmy.school::action` のような package 修飾キーでも `action` として受理し、`missing action` による parse/serialize error を抑止。
- **2026-02-11**: Brain の Port 5556（Motor Output）に `HEARTBEAT` を定期送信する運用を明記（Guardian の Brain Silence（>120s）誤検知を防ぐ）。送信は periodic maintenance から呼び出し、内部で約10秒スロットル。
- **2026-02-10**: `swimmy-watchdog` の自動復旧で `systemctl restart` が権限不足（polkit）で失敗するケースに対応し、失敗時は `systemctl show MainPID` → `SIGTERM/SIGKILL` で MainPID を落として systemd の `Restart=` に復旧させるフォールバックを追加。
- **2026-02-06**: `strategy_daily_pnl` の日次集計と 00:10 JST スケジュールを追加。日次PnL相関（Pearson）と非相関スコア通知（A/S昇格時）を実装。
- **2026-02-06**: Retired Rank を追加（Max Age退役、`data/library/RETIRED/`・`data/memory/retired.sexp`）。Evolution Report/DB集計に Retired を追加。
- **2026-02-06**: Pair-Composite の設計を確定し、`trade_logs` に `pair_id`、`backtest_trade_logs` を追加。`BACKTEST_RESULT` の `trade_list` を永続化し、`trades` は件数のまま維持。PnL系列は OOS/CPCV/Backtest を結合、`oos_kind` は `-OOS`=OOS / `-QUAL/-RR`=BACKTEST(IS) とする方針を明記（ペア選定/スコアは未実装）。候補母集団は **シンボル×TFごとの上位N=50** とする方針を追加。
- **2026-02-07**: ペア戦略の永続化・OOS/CPCV合成ゲート・ハイブリッド枠選抜・日次 00:10 スケジュール連携を実装。`pair_strategies` 保存、`CPCV_RESULT` trade_list 永続化、`refresh-pair-strategies`/`refresh-pair-active-defs` による選抜更新が稼働。
- **2026-02-06**: 起動時に `oos_queue` を全クリアし、古い request_id が残らないようにする方針を明記。
- **2026-02-06**: `BACKTEST_RESULT` の `request_id` を必須とする契約を明記。
- **2026-02-05**: 補助サービス（Data Keeper / Risk Gateway / Notifier）ZMQをS式のみに統一（legacy JSON廃止、`schema_version=1` 必須）。
- **2026-02-05**: Notifier の `payload`（S式）を受理し、`payload_json` 互換をINTERFACESに明記。
- **2026-02-05**: SBCLロード時WARNING/STYLE-WARNINGの全解消（ロード順、export、未使用変数、廃止フックの整理）。
- **2026-02-05**: 補助サービス（Data Keeper / Risk Gateway / Notifier）のS式スキーマをINTERFACESに定義（`schema_version=1`）。
- **2026-02-03**: Structured Telemetry を導入（JSONLイベントログ統合、`log_type="telemetry"`）。`system_metrics.sexp` / `live_status.sexp` を原子書き込みに統一。
- **2026-02-04**: `run.sh` の Brain 起動は `brain.lisp` 優先、欠落時はASDF直起動フォールバックの方針を明記。
- **2026-02-04**: Backtestのpending/レート制御とDeferred Flush制御パラメータをSTATEに明記。
- **2026-02-04**: `SWIMMY_BACKTEST_CSV_OVERRIDE` でBacktestのCSV差し替えを許可する方針を明記。
- **2026-02-04**: Backtest V2の`Option`表現（`timeframe`等）は空/1要素リストが正本と明記。
- **2026-02-04**: `tools/system_audit.sh` と `tools/test_notifier_direct.py` で `.env` を自動読み込みする運用に統一。
- **2026-02-04**: `tools/system_audit.sh` に `SUDO_CMD` で sudo 実行方法を上書きできる運用を追加（非対話 `sudo -n` 既定、必要時は対話式 `sudo`）。
- **2026-02-04**: MT5コマンド送信をS式に統一（ORDER_OPENは `instrument`/`side`）。`InpWSL_IP` のデフォルトを空に変更。
- **2026-02-04**: `backtest_status.txt` に `last_request_id` を追加。
- **2026-02-04**: MCPの `request_id` を JSON-RPC id/明示指定から引き回すよう統一。
- **2026-02-04**: `tools/dashboard.py` は systemd(system) の状態を正として表示する方針に統一。
- **2026-02-03**: REQ_HISTORY の要求キーを `count` に統一（`volume` は廃止）。
- **2026-02-03**: MT5系メッセージ（HISTORY/POSITIONS/SWAP_DATA/ORDER_ACK/TRADE_CLOSED）と管理コマンド（GET_POSITIONS/GET_SWAP/CLOSE_SHORT_TF）をINTERFACESに明記。
- **2026-02-04**: 内部ZMQはS式のみ（JSON受理しない）に厳格化。ORDER_OPENは`instrument/side/lot`に固定。
- **2026-02-01**: systemdの `swimmy-guardian` をRust Guardian実行に修正し、evolution daemonのSBCLメモリ設定を `SWIMMY_SBCL_DYNAMIC_SPACE_MB` に統一。watchdogのsystemdユニットを追加。
- **2026-02-01**: owners guide / runbook のsystemd操作をsystemレベル（`sudo systemctl ...`）に一本化。`.env` の読み込み方法を修正してコメント行エラーを解消。
- **2026-02-01**: Backtest ServiceのS式戦略名抽出正規表現を修正（`re.error: unbalanced parenthesis` 対策）。
- **2026-02-01**: monolith `swimmy.service` をrepoから削除（systemdコア4サービス構成へ完全移行）。
- **2026-02-01**: systemdのsystemレベル正本ユニット（brain/guardian/school/data-keeper/backtest/risk/notifier/evolution/watchdog）をrepo側に整備し、`User=swimmy`/絶対パス指定で統一。
- **2026-02-01**: arXiv Scout の `last_sent` をリセットし、手動通知を実行。
- **2026-01-31**: SBCLロード時WARNING/STYLE-WARNINGの解消（未定義関数/変数・ロード順・重複定義の整理）。
- **2026-01-31**: SBCLロード時STYLE-WARNING追加整理（未使用変数の無視/削除、LLM圧縮コンテキスト適用、Founders docstring登録）。
- **2026-01-31**: SBCLロード時の重複定義WARNING整理（`calculate-slope`/`format-duration` の衝突回避）。
- **2026-01-31**: SBCLロード時STYLE-WARNING追加整理（school-* の未使用変数/ハンドラ整理）。
- **2026-02-01**: 依存ライブラリ更新（Quicklisp dist 2026-01-01）と警告対策（pzmq ASDF命名、cl-sqlite CFFI struct参照、ironclad/postmodernのdefgeneric再定義ガード）。
- **2026-02-01**: school-breeder の括弧不整合を修正（ロード時COMPILE-FILEエラー解消）。
- **2026-02-17**: AランクOOS dispatch に explicit range を追加。`maybe-request-oos-backtest` が `data/historical/<SYMBOL>_M1.csv` の timestamp から 70/30 split を算出し、`request-backtest` に `start_time/end_time` を渡す契約へ更新（suffix は `-OOS` 維持）。
- **2026-02-17**: `request-backtest` が `:start-ts/:end-ts` を受け取り、S式 BACKTEST payload に `start_time/end_time`（Option Some 形式）を含められるよう更新。
- **2026-02-17**: Guardian の :5559 SXP BACKTEST ルートでも `start_time/end_time` スライスを適用。`sub_from_brain` ルートと同じ日付範囲セマンティクスに統一。
- **2026-02-17**: Top Candidates 表示を `TE official/composite=official_trades/backtest_trade_logs_count` へ拡張。並び順は `max(official, composite)` を trade evidence として `evidence-adjusted-sharpe` に反映。
- **2026-02-17**: MT5 `SendHistoryData` の default history window を長期TF向けに拡張（D1=20000, W1=10000, MN1=2400）。
- **2026-02-01**: Quicklisp dist側のパッチを撤回し、`local-projects` のパッチ版を優先利用する構成に整理。
- **2026-02-01**: SBCL起動オプションを `SWIMMY_SBCL_DYNAMIC_SPACE_MB` に統一（run.sh / tools / systemd）。
- **2026-02-01**: Quicklisp local-projects固定化スクリプトとパッチを追加（`tools/setup_quicklisp_local_projects.sh`）。
- **2026-02-01**: Quicklispパッチをunified diff形式に整形し、`patch` 適用エラーを解消。
- **2026-02-01**: SBCLサニティチェックを追加（`tools/sbcl_sanity_check.sh`）。
- **2026-02-01**: V3.0「61-STRATEGY SIGNAL SYSTEM」を `tools/restore_legend_61.lisp` で再登録（59本追加、2本は重複判定で除外）。弱体Legendは `archive-weak-legends` で LEGEND-ARCHIVE へ退避。
- **2026-02-01**: Legend保護テストスクリプト `tools/test_legend_protection.lisp` 追加（Fortress/ensure-rank を検証）。
- **2026-02-01**: Legend再検証フラグ `strategy-revalidation-pending` を追加し、起動時に `queue-legend-revalidation` を自動実行。`restore_legend_61.lisp` を swimmy-school の `ExecStartPre` に組み込み、LEGEND-ARCHIVE もライブラリロード対象に追加。
- **2026-01-31**: arXiv Scout 通知に S/A/B/C の優先度ラベルを追加（スコア閾値: S=9-10, A=8, B=6-7, C<=5）。
- **2026-01-31**: arXiv Scout の手動再送（`last_sent` リセット → `--daily` 実行）を実施。
- **2026-01-31**: arXiv Scout の `last_sent` をリセットして手動再送を実施。
- **2026-01-31**: `SWIMMY_GEMINI_API_KEY` を `/home/swimmy/swimmy/.env` に更新（ユーザー対応）。
- **2026-01-31**: arXiv Scout デーモンを再起動（Geminiキー反映）。
- **2026-01-31**: Backtest Service プロトコルを **S式に統一**（JSON要求は廃止）。Brain/School→Backtest Service→Guardian 間はS式でやり取り。
- **2026-01-31**: arXiv Scout のDiscord Webhookを更新（通知先切替）。
- **2026-01-31**: `SYSTEM_COMMAND: HEARTBEAT_NOW` を追加（ZMQ 5555経由でDiscord Heartbeatを即時送信可能に）。
- **2026-01-31**: `swimmy-school.service` を enable/active に復帰（4サービス体制を再確立）。
- **2026-01-31**: ZMQポートを `SWIMMY_PORT_*` で上書き可能に統一。Backtest Service は `SWIMMY_BACKTEST_SERVICE` で有効化。
- **2026-01-31**: Data Keeper のsystemdユニット名を `swimmy-data-keeper` に統一。
- **2026-01-31**: ZMQ bind endpointのフォーマットを修正（`tcp://*:<port>` の生成不備を解消）。
- **2026-01-31**: `tools/deep_audit.lisp` でDB/KB初期化後に比較するよう調整。
- **2026-01-31**: V2 Screeningの欠損リンク修正とGraveyard照合の正規化を反映（Rank一本化に合わせた接続）。
- **2026-01-31**: Rankディレクトリ移行ツール追加（`tools/migrate_library_to_rank.py`）。
- **V50.5.1**: Evolution Factory Reportのメトリクス同期修正 (DBからの強制リロードを追加)。
- **V50.5**: Symbolic Hashing (論理重複排除), Service Isolation (Scribe), Broken Arrow Watchdog。
- **V50.2**: Engine of Life (親子対決進化)。
- **V49.8**: SQL Migration (KBのSQLite化)。
- **V49.4**: Hot Reloading, Regime Hard Lock。

## Legend運用メモ (2026-02-01)
- V3.0「61-STRATEGY SIGNAL SYSTEM」を初期化時に自動復元＆再検証キュー投入（`initialize-system` / `tools/restore_legend_61.lisp`）。重複はHighlanderで排除。
- 再検証完了まで `strategy-revalidation-pending` を立て、Breedingから除外。BACKTEST_RESULT 適用時に自動クリア。
- LEGENDは墓場送りをブロック。弱いLegendは `archive-weak-legends` で `:legend-archive` として退避可能（`data/library/LEGEND-ARCHIVE/`）。LEGEND-ARCHIVE もロード対象に追加。
- `swimmy-school.service` の `ExecStartPre` で `tools/restore_legend_61.lisp` を実行し、起動時に Legends を自動復元＆再検証フラグセット（BACKTESTは本起動後に送信）。
- Breeding時のLegend占有率を各カテゴリ上位5本に制限、遺伝的距離しきい値を0.35へ強化。
- 保護テストは `tools/test_legend_protection.lisp`（CIでも実行）。

## Polymarket OpenClaw Runbook（任意）

### 状態確認（定常）
- Cycle timer（user）: `systemctl --user status swimmy-polymarket-openclaw.timer --no-pager`
- Cycle log: `tail -n 200 logs/polymarket_openclaw_cycle.log`
- Status（ファイル）: `python3 tools/polymarket_openclaw_status.py --output-dir data/reports/polymarket_openclaw_live`
- Status monitor（system）: `systemctl status swimmy-polymarket-openclaw-status.timer --no-pager`
- Notifier（system）: `systemctl status swimmy-notifier.service --no-pager`

### 停止（安全側）
- 自動売買停止（user）: `systemctl --user disable --now swimmy-polymarket-openclaw.timer`
- シグナル更新停止（user）: `systemctl --user disable --now swimmy-openclaw-signal-sync.timer`
- Status monitor 停止（system）: `sudo systemctl disable --now swimmy-polymarket-openclaw-status.timer`

### 初回セットアップ（最低限）
- Polymarket 側で **USDC Deposit** と **Approve Tokens** を 1 回通す（Allowance が 0 の間は注文が失敗する）。
- Allowance/Balances の診断: `python3 tools/polymarket_balance_allowance.py`
  - `balance` が USDC 残高、`allowances` が 0 でないこと（max uint が典型）。
- Proxy/Smart wallet を使う場合:
  - `POLYCLAW_LIVE_FUNDER=0x...` と `POLYCLAW_LIVE_SIGNATURE_TYPE=<int>` を設定する（EOA 署名者と funder が分離するため）。

### トラブルシュート（典型）
- `systemctl --user start swimmy-polymarket-openclaw.service` が無反応:
  - oneshot のため stdout が出ないのは正常。`systemctl --user status ...` と `journalctl --user -u ...`、`logs/polymarket_openclaw_cycle.log` を見る。
- status が `Health: disabled`:
  - cycle timer が disabled のときは意図的に disabled 扱い（stale 誤検知を抑止）。
- `missing_private_key`:
  - `POLYCLAW_LIVE_PRIVATE_KEY_FILE`（推奨）または `POLYCLAW_LIVE_PRIVATE_KEY` を設定する。
- `allowance=0` / `balance=0`:
  - Polymarket 側の Approve/Deposit が未完了。`tools/polymarket_balance_allowance.py` で確認する。

### セキュリティ（必須）
- 秘密鍵は `.env` 直書きではなく `POLYCLAW_LIVE_PRIVATE_KEY_FILE` を推奨。
  - 例: `~/.secrets/` を `chmod 700`、鍵ファイルは `chmod 600`
- Discord webhook は `config/.env.systemd` に隔離し、`chmod 600` で保護する（notifier/status は `.env` を読まない）。

## 次アクション
1. ドキュメント体系化（進行中）
2. 統合テスト手順の確立

## リスク
- **複雑性**: 3言語 + SQLite + Python(Data Keeper) の複合システム。
- **ネットワーク**: WSL-Windows間の通信遮断。
