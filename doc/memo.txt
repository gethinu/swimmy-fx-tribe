# å¯¾å¿œâ‘¡

äº†è§£ã—ãŸã€‚ã€ŒLisp Brain (æ†²æ³•)ã€ ã®å®Ÿè£…ã‚’é€²ã‚ã‚‹ã€‚
ç¾åœ¨ã€Lispã¯ã€Œèãï¼ˆInputï¼‰ã€ã“ã¨ã—ã‹ã§ããªã„ã€‚ã“ã‚Œã«ã€Œå‘½ã˜ã‚‹ï¼ˆOutputï¼‰ã€èƒ½åŠ›ã‚’ä¸ãˆã€å˜ãªã‚‹è¨˜éŒ²ä¿‚ã‹ã‚‰**ã€Œçµ±æ²»è€…ã€**ã¸ã¨æ˜‡æ ¼ã•ã›ã‚‹ã€‚
ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ‹¡å¼µã™ã‚‹ï¼š

- Afferent Nerve (æ±‚å¿ƒæ€§ç¥çµŒ): Rust -> Lisp (Port 5555) [Existing]
    - å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚„ææ¡ˆã‚’å—ã‘å–ã‚‹ã€‚
- Efferent Nerve (é å¿ƒæ€§ç¥çµŒ): Lisp -> Rust (Port 5556) [New]
    - PUB (Publisher) ã‚½ã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã€æ±ºå®šäº‹é …ã‚’å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹ã€‚
    - æ†²æ³•å¯©æŸ»ã®çµæœ (APPROVED / REJECTED) ã‚’é€ä¿¡ã™ã‚‹ã€‚
    Step 1: Constitution Logic Implementation
    src/server.lisp ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å®Œå…¨ã«æ›¸ãæ›ãˆã‚ˆã€‚
    ã“ã‚Œã«ã¯ã€å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç°¡æ˜“å¯©æŸ»ã—ã€JSONã§æŒ‡ä»¤ã‚’é€ã‚Šè¿”ã™ãƒ­ã‚¸ãƒƒã‚¯ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã€‚
    ;; src/server.lisp
    (eval-when (:compile-toplevel :load-toplevel :execute)
    (ql:quickload :pzmq :silent t)
    (ql:quickload :jsown :silent t))

(defpackage :swimmy.server
(:use :cl))

(in-package :swimmy.server)

;; --- Constitution (ç°¡æ˜“æ†²æ³•) ---
(defun judge-action (data)
"ãƒ‡ãƒ¼ã‚¿ã®æ­£å½“æ€§ã‚’å¯©æŸ»ã™ã‚‹ã€‚ä»Šå›ã¯ãƒ†ã‚¹ãƒˆç”¨ã«å˜ç´”ãªå¶æ•°ãƒ»å¥‡æ•°åˆ¤å®šã‚’è¡Œã†ã€‚"
(let ((iter (jsown:val data "iteration")))
(if (evenp iter)
(values "APPROVED" "Constitution check passed: Iteration is even.")
(values "REJECTED" "Constitution violation: Iteration is odd."))))

;; --- The Brain ---
(defun start-brain ()
(format t "~%ğŸ§  Swimmy Brain (Level 2) is active.~%")
(format t "   [Input :5555] <-- Rust Agent~%")
(format t "   [Output:5556] --> Rust Agent~%")
(force-output)

(let ((ctx (pzmq:ctx-new)))
(unwind-protect
(let ((receiver (pzmq:socket ctx :pull))
(publisher (pzmq:socket ctx :pub)))
(unwind-protect
(progn
;; 1. Input Nerve (PULL)
(pzmq:bind receiver "tcp://*:5555")
;; 2. Output Nerve (PUB)
(pzmq:bind publisher "tcp://*:5556")

```
              (loop
                (format t "Waiting for proposal...~%")
                (force-output)

                ;; å—ä¿¡ (Blocking)
                (let ((raw-msg (pzmq:recv-string receiver)))
                  (handler-case
                      (let* ((data (jsown:parse raw-msg))
                             (agent (jsown:val data "agent"))
                             (iter (jsown:val data "iteration")))

                        (format t "ğŸ“ Reviewing proposal from ~A (Iter: ~A)... " agent iter)

                        ;; æ†²æ³•å¯©æŸ»
                        (multiple-value-bind (verdict reason)
                            (judge-action data)

                          (format t "[~A]~%" verdict)

                          ;; æŒ‡ä»¤ï¼ˆJSONï¼‰ã®ä½œæˆ
                          (let ((response (jsown:to-json
                                           (jsown:new-js
                                             ("type" "command")
                                             ("verdict" verdict)
                                             ("reason" reason)
                                             ("reference_id" iter)))))

                            ;; æŒ‡ä»¤ã®é€ä¿¡ (Broadcast)
                            (pzmq:send-string publisher response)
                            (format t "   -> Command sent: ~A~%~%" response)
                            (force-output))))

                    (error (e)
                      (format t "!! FATAL ERROR: ~A~%" e)
                      (force-output))))))

         ;; Cleanup Sockets
         (pzmq:close receiver)
         (pzmq:close publisher)))
  ;; Cleanup Context
  (pzmq:ctx-destroy ctx))))

```

Step 2: Verification (ç‰‡å´ãƒ†ã‚¹ãƒˆ)
Rustå´ã¯ã¾ã å—ä¿¡æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ãªã„ãŒã€Lispå´ãŒæ­£å¸¸ã«ç¨¼åƒã—ã€è™šç©ºï¼ˆPort 5556ï¼‰ã«å‘ã‹ã£ã¦æŒ‡ä»¤ã‚’æŠ•ã’ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚

- Lisp Brainã®å†èµ·å‹•:
ä»¥å‰ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ Ctrl + C ã—ã¦åœæ­¢ã—ã€å†å®Ÿè¡Œã›ã‚ˆã€‚
ros -Q -L sbcl-bin -l ~/swimmy/src/server.lisp -e '(swimmy.server::start-brain)'
    
    æœŸå¾…å€¤: [Input :5555] [Output:5556] ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
    
- Rust Bodyã®å†å®Ÿè¡Œ:
åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å‹•ã„ã¦ã„ã‚‹ Rust ã‚’å†å®Ÿè¡Œï¼ˆã¾ãŸã¯ãã®ã¾ã¾æ”¾ç½®ã§ã‚‚ã‚ˆã„ãŒã€å†å®Ÿè¡Œæ¨å¥¨ï¼‰ã€‚
cargo run

Mission:
Lispå´ã®ãƒ­ã‚°ã‚’è¦‹ã‚ã€‚
ã“ã‚Œã¾ã§å˜ã«è¡¨ç¤ºã™ã‚‹ã ã‘ã ã£ãŸã®ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«**ã€Œå¯©æŸ»ã€ã¨ã€Œå‘½ä»¤ã€**ã‚’è¡Œã„å§‹ã‚ã¦ã„ã‚‹ã¯ãšã ã€‚
ğŸ“ Reviewing proposal from guardian-v1 (Iter: 42)... [APPROVED]
-> Command sent: {"type":"command","verdict":"APPROVED","reason":"..."}

ğŸ“ Reviewing proposal from guardian-v1 (Iter: 43)... [REJECTED]
-> Command sent: {"type":"command","verdict":"REJECTED","reason":"..."}

ã“ã‚ŒãŒç¢ºèªã§ããŸã‚‰ã€æ¬¡ã¯ã„ã‚ˆã„ã‚ˆRustå´ã«ã€Œè€³ï¼ˆSUBã‚½ã‚±ãƒƒãƒˆï¼‰ã€ã‚’å–ã‚Šä»˜ã‘ã€ã“ã®å‘½ä»¤ã«å¾“ã‚ã›ã‚‹ã€‚
Lispå´ã¯æ„å›³é€šã‚Šã«ã€Œçµ±æ²»ã€ã‚’é–‹å§‹ã—ãŸã‹ï¼Ÿ